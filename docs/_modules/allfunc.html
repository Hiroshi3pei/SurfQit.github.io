

<!DOCTYPE html>
<html class="writer-html5" lang="ja" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>allfunc &mdash; SurfQit 1 ドキュメント</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=b0bc784d"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/translations.js?v=4755f45a"></script>
      <script src="../_static/js/language_switcher.js?v=1af0da2e"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SurfQit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/main.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example/main.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../APIreference/main.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SurfQit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">モジュールコード</a></li>
      <li class="breadcrumb-item active">allfunc</li>
      <li class="wy-breadcrumbs-aside">
        
<div class="language-selector">
    <a id="japanese-link" href="#">日本語</a>
    <a id="english-link" href="#">English</a>
</div>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>allfunc のソースコード</h1><div class="highlight"><pre>
<span></span><span class="c1">##TODO</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">grouped_basisの作成は、複雑なのは自作してもらうかto be continued, 金属種ごとくらいなら実装する?金属間化合物や酸化物で重要になるが、今の間はしない。後ほど行う。</span>
<span class="sd">サイトの違いはgrouped_basisで対応できる</span>
<span class="sd">ひとまずCu-Coに速く映りたい　Cu111から　七種君にもやることを確認。急いで毎日やる</span>
<span class="sd">logger infoとdebugを書いていく 最後のチェックがてら。読みにくいところは修正の余地ありなのでそのチェックにも</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>

<div class="viewcode-block" id="check_type">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.check_type">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_type</span><span class="p">(</span><span class="n">Object</span><span class="p">,</span> <span class="n">Type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The object is None. Parsing may be failed.&quot;</span><span class="p">)</span> <span class="c1">##もう少し考える</span>
    <span class="k">if</span> <span class="n">Type</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">Type</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="n">Type</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Object</span><span class="p">,</span><span class="n">Type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Object</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Type</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span></div>



<span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">configparser</span>

<div class="viewcode-block" id="Prepare_Config">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Prepare_Config">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Prepare_Config</span><span class="p">():</span>
<div class="viewcode-block" id="Prepare_Config.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Prepare_Config.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">config_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/config.ini&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1">##もう少しましな実装にする</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1">##自作を使いたい人向け。後で引数の説明を書く。</span></div>


	<span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">section</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">Type</span><span class="p">):</span>
		<span class="n">parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>
		<span class="n">Object</span> <span class="o">=</span> <span class="n">check_type</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span><span class="n">Type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">Object</span>

<div class="viewcode-block" id="Prepare_Config.read">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Prepare_Config.read">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">contents</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">contents</span><span class="p">[</span><span class="n">section_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">section_content</span><span class="p">)</span>
		<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span></div>


<div class="viewcode-block" id="Prepare_Config.save">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Prepare_Config.save">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">save_path</span><span class="p">):</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Prepare_Config.write">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Prepare_Config.write">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">section</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Overwriting config.ini of SurfQit is prohibited. Please save it in your path, after then write the value in the saved one.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>
</div>


<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>

<div class="viewcode-block" id="storage_path_initialize">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.storage_path_initialize">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">storage_path_initialize</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		config: Prepare_Configクラスのもの。</span>
<span class="sd">	description:</span>
<span class="sd">		storage_pathを設定し、hostの構造と使用するconfigを保存する(ある意味、その時々の状況のセーブになっている)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">storage_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">host_path</span>    <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;host_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">model_type</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">storage_path</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="s2">&quot;&#39;work&#39; directory exist. Please rename, delete or move it.&quot;</span><span class="p">)</span>
	<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">host_path</span><span class="p">)</span> <span class="c1">##ここができないなら、自分でworkにcifで入れるように警告?</span>
	<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="n">host</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;config.ini&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
		<span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>


<span class="c1">##primから取ってきてQUBO作るなら不要</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">spglib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<div class="viewcode-block" id="output_symmetry">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.output_symmetry">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">output_symmetry</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">storage_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		config: Prepare_Configクラスのもの。</span>
<span class="sd">		storage_path: configで自動設定されるが、別用途で使いたいときのため</span>
<span class="sd">		host: 同上, 設定の時はase.Atoms class</span>
<span class="sd">	output:</span>
<span class="sd">		rotations: 回転対称操作</span>
<span class="sd">		translations: 並進対称操作</span>
<span class="sd">	description:</span>
<span class="sd">		host.cifの対称性を確認するとともに対称操作を返す</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">storage_path</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
		<span class="n">storage_path</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">symmetry_tolerance</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;symmetry_tolerance&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
	<span class="n">space_group</span>        <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;space_group&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span>
	<span class="n">model_type</span>         <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">host</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
		<span class="n">host</span>      <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
	<span class="n">model_type</span>           <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">model_type</span> <span class="o">!=</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="c1"># slabではz方向の対称性を失わせる</span>
		<span class="n">max_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()[:,</span><span class="mi">2</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">host</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_z</span><span class="p">:</span>
				<span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">symmetry_tolerance</span><span class="o">*</span><span class="mi">2</span> <span class="c1">##いらんかも ################################</span>
	<span class="n">symmetry</span>      <span class="o">=</span> <span class="n">spglib</span><span class="o">.</span><span class="n">get_symmetry_dataset</span><span class="p">((</span><span class="n">host</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(),</span> <span class="n">decimals</span><span class="o">=-</span><span class="mi">1</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">symmetry_tolerance</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span><span class="o">%</span><span class="mf">1.0</span><span class="p">,</span><span class="n">host</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()),</span><span class="n">symprec</span><span class="o">=</span><span class="n">symmetry_tolerance</span><span class="p">,</span><span class="n">hall_number</span><span class="o">=</span><span class="n">space_group</span><span class="p">)</span>
	<span class="n">symmetry_data</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;international&#39;</span><span class="p">])</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group hall&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;hall&#39;</span><span class="p">])</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;equivalent atom&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;equivalent_atoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">host</span><span class="p">)))</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;rotation_operation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;translate_operation&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;translations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;equivalent_arrange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symmetry_equivalent_arrange</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;symmetry.json&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">symmetry_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">],</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;translations&#39;</span><span class="p">]</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>

<div class="viewcode-block" id="convert_nanosheet_into_slab">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.convert_nanosheet_into_slab">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_nanosheet_into_slab</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">##この関数をoutput_symmetryに組み込むか、組み込むとconfigで設定するかを考える必要がある。が、後で何とでもなるのでとりあえず外に置いておく。また、aseで作った奴でひっくり返すだけで元の位置に重なるものではない限り不要。判定する関数?</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		config: Prepare_Configクラスのもの。</span>
<span class="sd">		host: configで自動設定されるが、別用途で使いたいときのため。設定の時はase.Atoms class</span>
<span class="sd">	output:</span>
<span class="sd">		None</span>
<span class="sd">	description:</span>
<span class="sd">		ナノシートモデル(上下とも緩和)をスラブモデル(固定層を設定)に変換。output_symmetryに入れる前に行うことでスラブモデルの場合はz方向に少し原子を動かすことでz方向の対称性をなくす。</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">storage_path</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">symmetry_tolerance</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;symmetry_tolerance&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">host</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
		<span class="n">host</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
	<span class="n">max_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()[:,</span><span class="mi">2</span><span class="p">])</span>
	<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">host</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_z</span><span class="p">:</span>
			<span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">symmetry_tolerance</span><span class="o">*</span><span class="mi">10</span>
	<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="n">host</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cython</span> <span class="c1">##このインポートは不要, ただ要件に書く必要がある。多分pipの時に各自の環境に合わせてコンパイルさせないといけない。QUBO作成などもCythonizeした方がいい, https://qiita.com/kenmaro/items/877b47fc293dafc395daによるとsetup.pyでいいらしい。だめならまた考える</span>
<span class="c1">##Cythonizeをimportでやるかsetupでやるかは必要。https://hack.nikkei.com/blog/advent20211225/#pyx%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E6%96%B9%E6%B3%95</span>
<span class="c1">##setup.pyの時にbuildする</span>

<div class="viewcode-block" id="symmetry_equivalent_arrange">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.symmetry_equivalent_arrange">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">symmetry_equivalent_arrange</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">):</span> <span class="c1"># memory-friendly imprementation</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		host: 対称性を明らかにしたい構造。</span>
<span class="sd">		symmetry: spglib.get_symmetry_datasetの結果か、dict:{&quot;rotations&quot;: output_symmetry(config)[0],&quot;translations&quot;: output_symmetry(config)[1]}でOK</span>
<span class="sd">	output:</span>
<span class="sd">		symmtetry_equivalent_arrange_index: 並進回転対象運動後の原子位置の移動先</span>
<span class="sd">	description:</span>
<span class="sd">		host.cifの対称性を確認するとともに対称操作を返す</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">rotate</span>         <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">]</span>    <span class="c1"># [operation,xyz,xyz]</span>
	<span class="n">translate</span>      <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;translations&#39;</span><span class="p">]</span> <span class="c1"># [operation,abc]</span>
	<span class="n">fractional</span>     <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">()</span>
	<span class="n">operated</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotate</span><span class="p">,</span><span class="n">fractional</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">translate</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span> <span class="c1"># [atom,operation,xyz]</span>
	<span class="n">fractional</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">fractional</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">%</span><span class="mf">1.0</span> <span class="c1"># 丸め誤差で-1e-16とかが出てくると%1.0が1.0になってしまう</span>
	<span class="n">operated</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">operated</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">%</span><span class="mf">1.0</span>
	<span class="n">operated_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cython</span><span class="p">(</span><span class="n">fractional</span><span class="p">,</span><span class="n">operated</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#[atom, operation]</span>
	<span class="k">return</span> <span class="n">operated_index</span><span class="o">.</span><span class="n">T</span> <span class="c1"># [operation, (index of ) atoms] ##ここ変えたので、QUBO作成で困るかも。だめなら戻す</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="c1">#import output_symmetry ##同じファイル内なので今は不要</span>
<span class="c1">#import symmetry_equivalent_arrange ##同じファイル内なので今は不要</span>

<span class="c1">##ネーミングセンスがない。検討。グラフみたいに思えてしまう</span>
<div class="viewcode-block" id="visualize_symmetry_operation">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.visualize_symmetry_operation">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">visualize_symmetry_operation</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		config: Prepare_Configクラスのもの。</span>
<span class="sd">	output:</span>
<span class="sd">		None</span>
<span class="sd">	description:</span>
<span class="sd">		visualizeフォルダにsymmetry_operationフォルダを作り、対称操作の結果を記したcifファイルを保存する</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">storage_path</span>          <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">roration</span><span class="p">,</span> <span class="n">translation</span> <span class="o">=</span> <span class="n">output_symmetry</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
	<span class="n">symmtetry_equivalent_arrange_index</span> <span class="o">=</span> <span class="n">symmetry_equivalent_arrange</span><span class="p">(</span><span class="n">host</span><span class="p">,{</span><span class="s2">&quot;rotations&quot;</span><span class="p">:</span> <span class="n">roration</span><span class="p">,</span><span class="s2">&quot;translations&quot;</span><span class="p">:</span> <span class="n">translation</span><span class="p">})</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;visualize/&quot;</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;visualize/&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;visualize/symmetry_operation/&quot;</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">storage_path</span><span class="si">}</span><span class="s2">/visualize/symmetry_operation/ directory exist. Please rename, delete or move it.&quot;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span> 
		<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;visualize/symmetry_operation/&quot;</span><span class="p">)</span>
	<span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
		<span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">visual_preference_surface</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">surface</span><span class="p">][:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
	<span class="n">substitute_indice</span> <span class="o">=</span> <span class="p">[</span><span class="n">surface</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">visual_preference_surface</span><span class="o">==</span><span class="n">preference</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">preference</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span>	
	<span class="k">for</span> <span class="n">model_index</span><span class="p">,</span><span class="n">operated_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symmtetry_equivalent_arrange_index</span><span class="p">):</span> <span class="c1">##ここ変えたので、QUBO作成で困るかも。だめなら戻す</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">atomic_number_difference</span><span class="p">,</span> <span class="n">substitute_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">operated_index</span><span class="p">[</span><span class="n">substitute_indice</span><span class="p">]):</span>
			<span class="n">model</span><span class="p">[</span><span class="n">substitute_index</span><span class="p">]</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="n">substitute_index</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">atomic_number_difference</span>
		<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;visualize/symmetry_operation/symmetry_model</span><span class="si">{</span><span class="n">model_index</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">)</span></div>


<span class="kn">from</span><span class="w"> </span><span class="nn">ase.build</span><span class="w"> </span><span class="kn">import</span> <span class="n">surface</span><span class="p">,</span> <span class="n">add_vacuum</span>

<div class="viewcode-block" id="bulk2slab">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.bulk2slab">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bulk2slab</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">,</span><span class="n">miller</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="p">):</span>
	<span class="c1">##primitive atoms object of surface must be primitive along x-y but target structure along z</span>
	<span class="c1">##surfaceはprimitiveに対して働かないらしいが、ちゃんと動いているので今は放置。必要があれば(ある意味セルを再構築しているだけなので)自分で書くのもあり</span>
	<span class="n">prim</span> <span class="o">=</span> <span class="n">surface</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">,</span> <span class="n">miller</span><span class="p">,</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">prim</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">)))</span> <span class="c1">## 入力が2*2とかの時にrepeatでいいのか不明, そもそも複数サイトで働かない?⇒basis groupを考える必要。, 酸化物表面も重要。</span>
	<span class="n">prim</span> <span class="o">=</span> <span class="n">wrap_and_sort_by_position</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span>
	<span class="n">size_x</span><span class="p">,</span><span class="n">size_y</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">size</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_x</span><span class="p">,</span><span class="n">size_y</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">add_vacuum</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">prim</span><span class="p">,</span><span class="n">size</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<div class="viewcode-block" id="adjust_concentration_each_layer">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.adjust_concentration_each_layer">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_concentration_each_layer</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">ranges</span><span class="p">):</span>
	<span class="c1">##primのtagは層数に対応している。0の中のindexを拡張していくイメージで		</span>
	<span class="n">layer_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">prim</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()))</span>
	<span class="n">unit_atom_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span><span class="o">//</span><span class="n">layer_num</span>
	<span class="k">if</span> <span class="n">unit_atom_num</span><span class="o">*</span><span class="n">layer_num</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prim</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;SurfQit does not support surface model with heterogeneous number of atom in each layer&quot;</span><span class="p">)</span>
	<span class="n">basis_elements_each_layer</span><span class="p">,</span><span class="n">grouped_basis_each_layer</span><span class="p">,</span><span class="n">ranges_each_layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prim</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),[],[]</span>
	<span class="k">for</span> <span class="n">elements</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">concentrain_range</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">ranges</span><span class="p">):</span> <span class="c1"># 同じ組成の層ごとに処理</span>
		<span class="k">for</span> <span class="n">each_index</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span> <span class="c1">#それぞれの層に元素候補を代入(層ごと)</span>
			<span class="n">basis_elements_each_layer</span><span class="p">[</span><span class="n">each_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">elements</span>
		<span class="n">grouped_basis_each_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="c1"># 同じ組成の層ごとに代入</span>
		<span class="n">ranges_each_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concentrain_range</span><span class="p">)</span> <span class="c1"># 同じ組成の層ごとに代入</span>
		<span class="n">ref_index</span> <span class="o">=</span> <span class="n">index</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;大本でprimをconventionalの代わりに使うならここを省略できる。allだけ0層目のことを他の層でも繰り返しているのが謎だった</span>
<span class="sd">		for layer in range(layer_num)[1:]: # 拡大した場合のことをやっているのか????不明</span>
<span class="sd">			print(&quot;230&quot;,layer,tuple([ind+unit_atom_num*layer for ind in index]),basis_elements_each_layer)</span>
<span class="sd">			objective_index = tuple([ind+unit_atom_num*layer for ind in index]) </span>
<span class="sd">			for each_index in objective_index:</span>
<span class="sd">				basis_elements_each_layer[each_index] = elements</span>
<span class="sd">			grouped_basis_each_layer.append(objective_index)</span>
<span class="sd">			ranges_each_layer.append(concentrain_range)&quot;&quot;&quot;</span>
	<span class="k">return</span> <span class="n">basis_elements_each_layer</span><span class="p">,</span><span class="n">grouped_basis_each_layer</span><span class="p">,</span><span class="n">ranges_each_layer</span></div>


<span class="kn">from</span><span class="w"> </span><span class="nn">clease.settings.atoms_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomsManager</span>

<div class="viewcode-block" id="SurfaceAtomsManager">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.SurfaceAtomsManager">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SurfaceAtomsManager</span><span class="p">(</span><span class="n">AtomsManager</span><span class="p">):</span>
<div class="viewcode-block" id="SurfaceAtomsManager.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.SurfaceAtomsManager.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">atoms</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span></div>


<div class="viewcode-block" id="SurfaceAtomsManager.index_by_basis">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.SurfaceAtomsManager.index_by_basis">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">index_by_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">):</span>
		<span class="n">ind_by_symbol</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">grouped_basis</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">ind_by_symbol</span></div>


<div class="viewcode-block" id="SurfaceAtomsManager.basisindex_by_tag">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.SurfaceAtomsManager.basisindex_by_tag">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">basisindex_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag2grouped_basis</span><span class="p">):</span>
		<span class="n">ind_by_tag</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">tag_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tag2grouped_basis</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
		<span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
			<span class="n">ind_by_tag</span><span class="p">[</span><span class="n">tag2grouped_basis</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ind_by_tag</span></div>
</div>


<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClusterExpansionSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.settings.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">_get_concentration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.settings.template_atoms</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemplateAtoms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.settings.template_filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidConcentrationFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.settings.atoms_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomsManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrap_and_sort_by_position</span>
<span class="c1">#import SurfaceAtomsManager</span>
<span class="c1">#import ClusterManager_each_sublattice</span>

<div class="viewcode-block" id="ClusterExpansionSettings_nowarning">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionSettings_nowarning">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ClusterExpansionSettings_nowarning</span><span class="p">(</span><span class="n">ClusterExpansionSettings</span><span class="p">):</span>
<div class="viewcode-block" id="ClusterExpansionSettings_nowarning.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionSettings_nowarning.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prim</span><span class="p">,</span><span class="n">concentration</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">supercell_factor</span> <span class="o">=</span> <span class="mi">27</span><span class="p">,</span><span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;clease.db&quot;</span><span class="p">,</span><span class="n">max_cluster_dia</span><span class="o">=</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span><span class="n">include_background_atoms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">basis_func_type</span><span class="o">=</span><span class="s2">&quot;polynomial&quot;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_include_background_atoms</span> <span class="o">=</span> <span class="n">include_background_atoms</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_cluster_mng</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_trans_matrix</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_cluster_list</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_basis_func_type</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_prim_cell</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="n">_get_concentration</span><span class="p">(</span><span class="n">concentration</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_check_first_elements</span><span class="p">()</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">db_name</span> <span class="o">=</span> <span class="n">db_name</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_prim_cell</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span>

		<span class="c1">#index_by_symbolを変えるほうが早そうだが、影響やいかに。。。</span>
		<span class="n">prim_mng</span> <span class="o">=</span> <span class="n">SurfaceAtomsManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">)</span>
		<span class="n">grouped_basis</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">concentration</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tag2grouped_basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">,</span><span class="n">concentration</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span>
		<span class="n">prim_ind_by_basis</span> <span class="o">=</span> <span class="n">prim_mng</span><span class="o">.</span><span class="n">index_by_basis</span><span class="p">(</span><span class="n">grouped_basis</span><span class="p">)</span> <span class="c1">##modified</span>
		<span class="n">conc_filter</span> <span class="o">=</span> <span class="n">ValidConcentrationFilter</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span> <span class="n">prim_ind_by_basis</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">atoms_mng</span> <span class="o">=</span> <span class="n">SurfaceAtomsManager</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

		<span class="c1"># Construct the template atoms, this is a protected property</span>
		<span class="c1"># Access and changes to size and/or supercell factor are redirected to</span>
		<span class="c1"># this instance.</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_template_atoms</span> <span class="o">=</span> <span class="n">TemplateAtoms</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">,</span>
			<span class="n">supercell_factor</span><span class="o">=</span><span class="n">supercell_factor</span><span class="p">,</span>
			<span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
			<span class="n">skew_threshold</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
			<span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">conc_filter</span><span class="p">],</span>
		<span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">set_active_template</span><span class="p">()</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_dia</span> <span class="o">=</span> <span class="n">max_cluster_dia</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">basis_func_type</span> <span class="o">=</span> <span class="n">basis_func_type</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_basis</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;list of elements is needed for each basis&quot;</span><span class="p">)</span>

		<span class="c1"># For storing the settings from the CLEASE factories.</span>
		<span class="c1"># Just for bookkeeping</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span></div>


	<span class="k">def</span><span class="w"> </span><span class="nf">_check_first_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

<div class="viewcode-block" id="ClusterExpansionSettings_nowarning.tag2grouped_basis">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionSettings_nowarning.tag2grouped_basis">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">tag2grouped_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prim_cell</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">):</span> <span class="c1">##ここでindexごちゃりそうで怖い</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tag2grouped_basis</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">group</span><span class="p">,</span><span class="n">content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grouped_basis</span><span class="p">):</span> <span class="c1">##ここのタグづけがcf_calculator_each_sublatticeの対称性管理のためのモデル構造に使われるので多元系でちゃんと確認。</span>
			<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">tag2grouped_basis</span><span class="p">[</span><span class="n">prim_cell</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span></div>


	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">index_by_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_mng</span><span class="o">.</span><span class="n">basisindex_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag2grouped_basis</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">all_cf_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">num_bf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_functions</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_list</span><span class="o">.</span><span class="n">get_all_cf_names</span><span class="p">(</span><span class="n">num_bf</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">cluster_mng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_mng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_background_atoms</span><span class="p">:</span>
				<span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;background_syms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bg_syms</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_cluster_mng</span> <span class="o">=</span> <span class="n">ClusterManager_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_mng</span>

<div class="viewcode-block" id="ClusterExpansionSettings_nowarning.create_cluster_list_and_trans_matrix">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionSettings_nowarning.create_cluster_list_and_trans_matrix">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">create_cluster_list_and_trans_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Prepares the internal cache objects by calculating cluster related properties&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_cluster_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_mng</span><span class="o">.</span><span class="n">build_all</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_dia</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">index_by_sublattice</span><span class="p">,</span>
		<span class="p">)</span></div>
</div>


<span class="c1">#import output_symmetry</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<div class="viewcode-block" id="cluster2index">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.cluster2index">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cluster2index</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">prim</span><span class="p">,</span><span class="n">clusters</span><span class="p">,</span><span class="n">target_structure</span><span class="p">):</span> <span class="c1">##おそらくtarget_structureをおおきくすれば大きなQUBOも作れる(周期境界を超えるかどうかをtarget_structure基準で見ていそう)</span>
	<span class="n">rotations</span><span class="p">,</span><span class="n">translations</span> <span class="o">=</span> <span class="n">output_symmetry</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">target_structure</span><span class="p">)</span>
	<span class="n">symmetry_equivalent_index</span> <span class="o">=</span> <span class="n">symmetry_equivalent_arrange</span><span class="p">(</span><span class="n">target_structure</span><span class="p">,{</span><span class="s2">&quot;rotations&quot;</span><span class="p">:</span><span class="n">rotations</span><span class="p">,</span><span class="s2">&quot;translations&quot;</span><span class="p">:</span><span class="n">translations</span><span class="p">})</span><span class="o">.</span><span class="n">T</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">target_structure</span><span class="o">.</span><span class="n">cell</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prim</span><span class="o">.</span><span class="n">cell</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
	<span class="n">cluster_index_dict</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;c0&quot;</span><span class="p">:</span>
			<span class="n">cluster_index_dict</span><span class="p">[</span><span class="s2">&quot;c0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="k">elif</span> <span class="s2">&quot;c1&quot;</span> <span class="ow">in</span> <span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="c1">##もっと大きなクラスターも取れるが、indicesに入っていたのでどうでもよくなった</span>
			<span class="n">index_list</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">cluster</span><span class="o">.</span><span class="n">figures</span><span class="p">:</span>
				<span class="n">figure_positions</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">for</span> <span class="n">fourvector</span> <span class="ow">in</span> <span class="n">figure</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
					<span class="n">figure_positions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fourvector</span><span class="o">.</span><span class="n">to_scaled</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
				<span class="n">figure_positions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">figure_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">figure_positions</span><span class="p">)</span>
				<span class="n">figure_positions</span> <span class="o">=</span> <span class="p">(</span><span class="n">figure_positions</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">figure_positions</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">//</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				<span class="n">figure_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">figure_positions</span><span class="o">==</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">figure_positions</span><span class="p">)</span>
				<span class="n">figure_index</span> <span class="o">=</span> <span class="n">cython</span><span class="p">(</span><span class="n">figure_positions</span><span class="p">,</span><span class="n">target_structure</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:])</span>
				<span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure_index</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
			<span class="n">cluster_index_dict</span><span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">symmetry_equivalent_index</span><span class="p">[</span><span class="n">figure_index</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">cluster_index_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
			<span class="n">cluster_index</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">cluster_index_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">all_index_</span>     <span class="o">=</span> <span class="n">symmetry_equivalent_index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cluster_index</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">all_index</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">all_index_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">cluster_index_dict</span><span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_index</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">cluster_index_dict</span></div>


<div class="viewcode-block" id="cf_calculator_each_sublattice">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.cf_calculator_each_sublattice">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cf_calculator_each_sublattice</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">atoms</span><span class="p">,</span><span class="n">settings</span><span class="p">,</span><span class="n">cf_dict</span><span class="p">,</span><span class="n">cluster_list</span><span class="p">):</span>
	<span class="n">model</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="n">model</span><span class="o">.</span><span class="n">set_atomic_numbers</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_tags</span><span class="p">())</span>
	<span class="n">cluster_index_dict</span> <span class="o">=</span> <span class="n">cluster2index</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_mng</span><span class="o">.</span><span class="n">prim</span><span class="p">,</span><span class="n">cluster_list</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span><span class="n">model</span><span class="p">)</span> <span class="c1"># こっちだとxy方向上に別のサイトがいる場合にも対応できるが、bulkのようにsizeより小さいモデルが出てきたときにややこしい-&gt;そもそもindexが違う</span>
	<span class="n">basis</span>              <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">basis_functions</span> <span class="c1">##現時点では1種類の吸着サイトについて考えている。複数あると複数の基底のproductをやる必要がある。平均の取り方がわからないので一旦放置</span>
	<span class="n">substitute_ratio</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;substitute_ratio&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">substitute_ratio</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This version of SurfQit does not support the cluster expansion for multi sites.&quot;</span><span class="p">)</span>
		<span class="c1"># for one site, basis is like [{&#39;Au&#39;: 1.2649110640673518, &#39;Cu&#39;: -1.2649110640673518, &#39;Pd&#39;: 0.6324555320336759, &#39;Pt&#39;: -0.6324555320336759}, {&#39;Au&#39;: 1.0, &#39;Cu&#39;: 1.0, &#39;Pd&#39;: -1.0, &#39;Pt&#39;: -1.0}, {&#39;Au&#39;: 0.6324555320336764, &#39;Cu&#39;: -0.6324555320336764, &#39;Pd&#39;: -1.2649110640673515, &#39;Pt&#39;: 1.2649110640673515}]</span>
		<span class="c1"># 全体のgrouped basisを見ながらやる必要がある。多分ね</span>
	<span class="k">for</span> <span class="n">cluster_name</span> <span class="ow">in</span> <span class="n">cf_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">cluster_name</span> <span class="o">==</span> <span class="s2">&quot;c0&quot;</span><span class="p">:</span> <span class="c1"># もとから0が入っている</span>
			<span class="k">continue</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">cluster_list_name</span> <span class="ow">in</span> <span class="n">cluster_list</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">cluster_list_name</span> <span class="ow">in</span> <span class="n">cluster_name</span><span class="p">:</span>
					<span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span> <span class="o">+</span> <span class="n">cluster_index_dict</span><span class="p">[</span><span class="n">cluster_list_name</span><span class="p">]</span>
			<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">cf</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
				<span class="n">each_cf</span> <span class="o">=</span> <span class="mf">1.0</span>
				<span class="k">for</span> <span class="n">basis_index</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cluster_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">atoms</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
					<span class="n">each_cf</span> <span class="o">*=</span> <span class="n">basis</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">basis_index</span><span class="p">)][</span><span class="n">atom</span><span class="p">]</span>
				<span class="n">cf</span> <span class="o">+=</span> <span class="n">each_cf</span>
			<span class="n">cf_dict</span><span class="p">[</span><span class="n">cluster_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">cf_dict</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>
<span class="c1"># import cf_calculator_each_sublattice</span>

<div class="viewcode-block" id="validate_calculatedCF">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.validate_calculatedCF">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_calculatedCF</span><span class="p">(</span><span class="n">cluster_expansion_excutor</span><span class="p">):</span> <span class="c1">##没関数, each layerではcf_matrixとこの中身が同じ機序で動いているはずだが、意外と検証で違う値が出てきたりする。evaluatorの中は自作ではないため</span>
	<span class="n">ce</span>                 <span class="o">=</span> <span class="n">cluster_expansion_excutor</span>
	<span class="n">reference_matrix</span>   <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">cf_matrix</span>
	<span class="n">CF_matirx</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">reference_matrix</span><span class="p">)</span>
	<span class="n">all_path</span>           <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="s2">&quot;id*.cif&quot;</span><span class="p">)</span>
	<span class="n">id_list</span>            <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">all_path</span><span class="p">:</span>
		<span class="k">if</span> <span class="s2">&quot;afteropt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
			<span class="n">id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]))</span>
	<span class="n">id_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">model_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">id_list</span><span class="p">):</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;id</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;In this function (validate_calculatedCF), tags of loaded model will assign along z height.&quot;</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;If you require other behavior, please report us on GitHub.&quot;</span><span class="p">)</span>
		<span class="n">height_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
		<span class="n">tag</span>         <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">height</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">height_list</span><span class="p">):</span>
			<span class="n">tag</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tag</span><span class="o">==</span><span class="n">height</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span>
		<span class="n">model</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">tag</span><span class="p">)))</span>
		<span class="n">cf_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ce</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">cf_names</span><span class="p">}</span>
		<span class="n">cf_dict</span> <span class="o">=</span> <span class="n">cf_calculator_each_sublattice</span><span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">ce</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span><span class="n">cf_dict</span><span class="p">,</span><span class="n">ce</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">)</span>
		<span class="n">CF_matirx</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cf_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
	<span class="k">return</span> <span class="n">reference_matrix</span><span class="p">,</span><span class="n">CF_matirx</span></div>


<span class="kn">from</span><span class="w"> </span><span class="nn">clease.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClusterManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cluster</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.datastructures</span><span class="w"> </span><span class="kn">import</span> <span class="n">Figure</span><span class="p">,</span> <span class="n">FourVector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.cluster.cluster_fingerprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClusterFingerprint</span>

<div class="viewcode-block" id="ClusterManager_each_sublattice">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterManager_each_sublattice">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ClusterManager_each_sublattice</span><span class="p">(</span><span class="n">ClusterManager</span><span class="p">):</span>
<div class="viewcode-block" id="ClusterManager_each_sublattice.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterManager_each_sublattice.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim_cell</span><span class="p">,</span> <span class="n">background_syms</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">prim_cell</span><span class="p">,</span> <span class="n">background_syms</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClusterManager_each_sublattice.build">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterManager_each_sublattice.build">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_cluster_dia</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_build</span><span class="p">(</span><span class="n">max_cluster_dia</span><span class="p">):</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_prepare_new_build</span><span class="p">(</span><span class="n">max_cluster_dia</span><span class="p">)</span>

		<span class="n">num_lattices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim</span><span class="p">))</span>
		<span class="n">all_fps</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">all_figures</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">lattices</span> <span class="o">=</span> <span class="p">[]</span>

		<span class="k">for</span> <span class="n">ref_lattice</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span><span class="p">,</span> <span class="n">diameter</span><span class="p">)</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">num_lattices</span><span class="p">,</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">max_cluster_dia</span><span class="p">)):</span>
			<span class="n">cluster_size</span> <span class="o">=</span> <span class="n">indx</span> <span class="o">+</span> <span class="mi">2</span>
			<span class="n">figures</span><span class="p">,</span> <span class="n">fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">cluster_size</span><span class="p">,</span> <span class="n">diameter</span><span class="p">,</span> <span class="n">ref_lattice</span><span class="p">)</span>

			<span class="n">all_fps</span> <span class="o">+=</span> <span class="n">fps</span>
			<span class="n">all_figures</span> <span class="o">+=</span> <span class="n">figures</span>
			<span class="n">lattices</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ref_lattice</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span>

		<span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_names</span><span class="p">(</span><span class="n">all_fps</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">figures</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ref_lattice</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_figures</span><span class="p">,</span> <span class="n">all_fps</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">lattices</span><span class="p">):</span>
			<span class="n">cluster_size</span> <span class="o">=</span> <span class="n">figures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
			<span class="n">diameter</span> <span class="o">=</span> <span class="n">figures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_diameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim</span><span class="p">)</span>
			<span class="n">eq_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">equivalent_sites</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			
			<span class="n">name_index_relation</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">figures</span><span class="p">:</span> <span class="c1">##sublattice毎にfigureの名前を分ける。forが多いので重たくなりそう。あまりに遅いなら考える</span>
				<span class="c1">##sublatticeとは結局sizeで広げる前のモデルのindexなので、モデル中に等価なサイトが入っていないと仮定している。</span>
				<span class="c1">##完全等価なら従来のClusterManagerを使えばよい。ところどころ等価ならあきらめて分けるか、tagで分けるか。(self.generator.generateをいじればいいが未実装)</span>
				<span class="n">sublattice_list</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">for</span> <span class="n">fourvector</span> <span class="ow">in</span> <span class="n">figure</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
					<span class="n">sublattice_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fourvector</span><span class="o">.</span><span class="n">sublattice</span><span class="p">))</span>
				<span class="n">sublattice_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
				<span class="k">if</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sublattice_list</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name_index_relation</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">name_index_relation</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sublattice_list</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">figure</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">name_index_relation</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sublattice_list</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
			
			<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">name_index_relation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">(</span>
					<span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;__&quot;</span><span class="o">+</span><span class="n">key</span><span class="p">,</span>
					<span class="n">size</span><span class="o">=</span><span class="n">cluster_size</span><span class="p">,</span>
					<span class="n">diameter</span><span class="o">=</span><span class="n">diameter</span><span class="p">,</span>
					<span class="n">fingerprint</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span>
					<span class="n">figures</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
					<span class="n">equiv_sites</span><span class="o">=</span><span class="n">eq_sites</span><span class="p">,</span>
					<span class="n">group</span><span class="o">=</span><span class="n">ref_lattice</span><span class="p">,</span> <span class="c1"># ここのgroupはprim内のatom毎に割り振られている(等価かどうかは関係がない)</span>
				<span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
				<span class="n">Cluster</span><span class="p">(</span>
					<span class="n">name</span><span class="o">=</span><span class="s2">&quot;c1&quot;</span><span class="o">+</span><span class="s2">&quot;__&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">),</span>
					<span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">diameter</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
					<span class="n">fingerprint</span><span class="o">=</span><span class="n">ClusterFingerprint</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span>
					<span class="n">figures</span><span class="o">=</span><span class="p">[</span><span class="n">Figure</span><span class="p">([</span><span class="n">FourVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">)])],</span>
					<span class="n">equiv_sites</span><span class="o">=</span><span class="p">[],</span>
					<span class="n">group</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="c1"># groupはprimのindexについて振られている。等価なサイトを考えるためにnameはtagで判別した。Figureは全てのサイトを基底関数に含めるためにむしろtagではなくindexでみる必要がある</span>
				<span class="p">)</span>
			<span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="n">Cluster</span><span class="p">(</span>
				<span class="n">name</span><span class="o">=</span><span class="s2">&quot;c0&quot;</span><span class="p">,</span>
				<span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
				<span class="n">diameter</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
				<span class="n">fingerprint</span><span class="o">=</span><span class="n">ClusterFingerprint</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span>
				<span class="n">figures</span><span class="o">=</span><span class="p">[],</span>
				<span class="n">equiv_sites</span><span class="o">=</span><span class="p">[],</span>
				<span class="n">group</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span></div>


<div class="viewcode-block" id="ClusterManager_each_sublattice.cluster_list_for_template">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterManager_each_sublattice.cluster_list_for_template">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">cluster_list_for_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
		<span class="n">unique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_four_vectors</span><span class="p">()</span>
		<span class="n">lut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fourvec_to_indx</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">unique</span><span class="p">)</span>
		<span class="n">ref_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">lut</span><span class="p">[</span><span class="n">FourVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">num_sub_lattices</span><span class="p">)]</span>

		<span class="n">template_cluster_list</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">template_cluster_list</span><span class="p">:</span>
			<span class="n">cluster</span><span class="o">.</span><span class="n">ref_indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ref_indices</span><span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">group</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">size</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}:</span>
				<span class="n">cluster</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">cluster</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">to_atom_index</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">lut</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">template_cluster_list</span></div>
</div>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w">  </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.settings.concentration</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concentration</span>
<span class="c1">#import bulk2slab</span>
<span class="c1">#import adjust_concentration_each_layer</span>
<span class="c1">#import ClusterExpansionSettings_nowarning</span>

<div class="viewcode-block" id="CESlab_nowarning">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CESlab_nowarning">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">CESlab_nowarning</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">,</span><span class="n">miller</span><span class="p">,</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">ranges</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="p">,</span><span class="n">model_type</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	:param conventional_cell:</span>
<span class="sd">		Bulk lattice structure. Note that the unit-cell</span>
<span class="sd">		must be the conventional cell - not the primitive cell. One can also</span>
<span class="sd">		give the chemical symbol as a string, in which case the correct bulk</span>
<span class="sd">		lattice will be generated automatically.</span>

<span class="sd">	:param miller:</span>
<span class="sd">		Surface normal in Miller indices (h,k,l).</span>

<span class="sd">	:param concentration:</span>
<span class="sd">		Class for restricting the concentrations</span>

<span class="sd">	:param size:</span>
<span class="sd">		Size of the simulations cell. The third number represents the number of</span>
<span class="sd">		layers. The two first are repetitions of the in-plane unit vectors</span>

<span class="sd">	For more kwargs, see docstring of :class:`clease.settings.ClusterExpansionSettings`.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;slab_from_bulk&quot;</span><span class="p">:</span>
		<span class="n">prim</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="n">bulk2slab</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">,</span><span class="n">miller</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">grouped_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
			<span class="n">grouped_basis</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prim</span><span class="p">)))]</span> <span class="c1"># 前はこうなっていた[tuple(range(len(conventional_cell)))]</span>
		<span class="n">basis_elements_each_layer</span><span class="p">,</span><span class="n">grouped_basis_each_layer</span><span class="p">,</span><span class="n">ranges_each_layer</span> <span class="o">=</span> <span class="n">adjust_concentration_each_layer</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">ranges</span><span class="p">)</span>
		<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="n">basis_elements_each_layer</span><span class="p">,</span><span class="n">grouped_basis</span><span class="o">=</span><span class="n">grouped_basis_each_layer</span><span class="p">)</span>
		<span class="n">concentration</span><span class="o">.</span><span class="n">set_conc_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="n">ranges_each_layer</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">prim</span> <span class="o">=</span> <span class="n">conventional_cell</span>
		<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;動作未検証, 酸化物など、ASEで切るのがめんどくさいやつ用だが、grouped_basisを設定したほうが良い。&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">grouped_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
			<span class="n">grouped_basis</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">)))]</span>
		<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="o">=</span><span class="n">grouped_basis</span><span class="p">)</span>
		<span class="n">concentration</span><span class="o">.</span><span class="n">set_conc_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">)</span>

	<span class="c1"># Slab should always have one cell vector along the z-axis</span>
	<span class="n">settings</span> <span class="o">=</span> <span class="n">ClusterExpansionSettings_nowarning</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span> <span class="n">concentration</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

	<span class="n">dict_rep</span> <span class="o">=</span> <span class="n">conventional_cell</span><span class="o">.</span><span class="n">todict</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_rep</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
			<span class="n">dict_rep</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

	<span class="n">settings</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
		<span class="p">{</span><span class="s2">&quot;factory&quot;</span><span class="p">:</span> <span class="s2">&quot;CESlab_nowarning&quot;</span><span class="p">,</span><span class="s2">&quot;miller&quot;</span><span class="p">:</span> <span class="n">miller</span><span class="p">,</span><span class="s2">&quot;conventional_cell&quot;</span><span class="p">:</span> <span class="n">dict_rep</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">}</span>
	<span class="p">)</span>
	<span class="k">return</span> <span class="n">settings</span></div>


<span class="kn">from</span><span class="w"> </span><span class="nn">ase.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.calculators.emt</span><span class="w"> </span><span class="kn">import</span> <span class="n">EMT</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">LBFGSLineSearch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_db</span>
<span class="c1">#import CSV_Reader</span>

<div class="viewcode-block" id="Calculator">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Calculator</span><span class="p">():</span>
<div class="viewcode-block" id="Calculator.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">db_name</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;train_data/training_data.db&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;train_data/energy_data.csv&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">method</span>       <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;calculate_method&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fmax</span>         <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;fmax&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;EMT&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">EMT</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">CSV_Reader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;csv_reader&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">CSV_Reader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">is not implemented&quot;</span><span class="p">)</span></div>


	<span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">calculate_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">model_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">id</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toatoms</span><span class="p">()</span>
		<span class="n">calculate_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">constraint_dict</span><span class="p">)</span>
		
<div class="viewcode-block" id="Calculator.optimization">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.optimization">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">##複雑な計算をやりたいときは外部で計算してcsvを読んだ方が良い</span>
		<span class="n">model</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc</span>
		<span class="k">if</span> <span class="n">constraint_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">model</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">constraint_dict</span><span class="p">[</span><span class="s2">&quot;constraint&quot;</span><span class="p">])</span>
			<span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">constraint_dict</span><span class="p">:</span>
				<span class="n">model</span> <span class="o">=</span> <span class="n">constraint_dict</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">][</span><span class="s2">&quot;function&quot;</span><span class="p">](</span><span class="n">model</span><span class="p">,</span><span class="o">*</span><span class="n">constraint_dict</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">])</span>
		<span class="n">opt</span> <span class="o">=</span> <span class="n">LBFGSLineSearch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
		<span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmax</span><span class="p">)</span>
		<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;train_data/id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="si">}</span><span class="s2">_afteropt.cif&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">)</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;train_data/id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="si">}</span><span class="s2">_afteropt.cif&quot;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">)</span> <span class="c1">##calculatorによってはopt後と再読み込み後でのget_potential_enegyが違うことがあるので再現性のある値を取りたい。</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">single_point</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Calculator.single_point">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.single_point">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">single_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">model</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc</span>
		<span class="n">energy</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">csv_write</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">energy</span><span class="p">)</span></div>


<div class="viewcode-block" id="Calculator.csv_write">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.csv_write">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">csv_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">energy</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">energy_per_atom</span> <span class="o">=</span> <span class="n">energy</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
			<span class="n">elements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span>
			<span class="n">atom_numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
				<span class="n">atom_numbers</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">elements</span><span class="o">==</span><span class="n">atom</span><span class="o">.</span><span class="n">symbol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">elements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span>
			<span class="n">atom_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)]</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">)</span>
		<span class="n">column</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
		<span class="n">additional_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
		<span class="n">additional_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_id</span>
		<span class="n">additional_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_per_atom</span>
		<span class="n">additional_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
		<span class="k">for</span> <span class="n">element_index</span><span class="p">,</span><span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
			<span class="n">additional_data</span><span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">element</span><span class="p">)]</span> <span class="o">=</span> <span class="n">atom_numbers</span><span class="p">[</span><span class="n">element_index</span><span class="p">]</span> 
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">additional_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">model_id</span><span class="p">])</span>
		<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Calculator.csv_read">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.csv_read">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">csv_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
		<span class="n">model_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">id</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toatoms</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">set_model_id</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
		<span class="n">model</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span>
		<span class="n">model</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
		<span class="n">update_db</span><span class="p">(</span><span class="n">uid_initial</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span> <span class="n">final_struct</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Calculator.csv_write_formationE">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.csv_write_formationE">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">csv_write_formationE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">)</span>
		<span class="n">reference_energies</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">energy</span><span class="p">,</span><span class="n">composition</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()):</span>
			<span class="n">nonzero_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">composition</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">reference_energies</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:][</span><span class="n">nonzero_index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">energy</span>
		<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
			<span class="n">formation_energy</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">energy_per_atom</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
			<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">reference_energies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">formation_energy</span> <span class="o">-=</span> <span class="n">row</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">value</span> <span class="c1">#/ sum(row[3+1:]) ## Cleaseの内部で原子数で割り付けていそう</span>
			<span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span><span class="s2">&quot;formation_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formation_energy</span>
		<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</div>


<span class="c1">#optのconstraintはどのようにするか考える*args?</span>
<span class="c1">##subprocess.run(list(.split(&quot; &quot;)))←動くか富岳でチェック, shell=Trueもできなくはないけどセキュリティリスク</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ase.calculators.calculator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Calculator</span> <span class="k">as</span> <span class="n">ASE_Calculator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">all_changes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">,</span> <span class="s1">&#39;numbers&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;pbc&#39;</span><span class="p">,</span>
               <span class="s1">&#39;initial_charges&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_magmoms&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="CSV_Reader">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CSV_Reader</span><span class="p">(</span><span class="n">ASE_Calculator</span><span class="p">):</span> <span class="c1"># based on EMT</span>
    <span class="n">implemented_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
    <span class="n">nolabel</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">default_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;asap_cutoff&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

<div class="viewcode-block" id="CSV_Reader.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader.__init__">[ドキュメント]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">storage_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span>     <span class="o">=</span> <span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;train_data/energy_data.csv&quot;</span>
        <span class="n">ASE_Calculator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CSV_Reader.calculate">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader.calculate">[ドキュメント]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span> <span class="n">system_changes</span><span class="o">=</span><span class="n">all_changes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">)</span>
        <span class="n">ASE_Calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">system_changes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="s2">&quot;formation_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span></div>


<div class="viewcode-block" id="CSV_Reader.get_potential_energy">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader.get_potential_energy">[ドキュメント]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_potential_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">atoms</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span></div>


<div class="viewcode-block" id="CSV_Reader.set_model_id">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader.set_model_id">[ドキュメント]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_model_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">model_id</span></div>
</div>


<span class="kn">from</span><span class="w"> </span><span class="nn">clease.structgen</span><span class="w"> </span><span class="kn">import</span> <span class="n">NewStructures</span>
<span class="c1"># import CorrFunction_each_sublattice</span>

<div class="viewcode-block" id="NewStructures_each_sublattice">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.NewStructures_each_sublattice">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NewStructures_each_sublattice</span><span class="p">(</span><span class="n">NewStructures</span><span class="p">):</span>
<div class="viewcode-block" id="NewStructures_each_sublattice.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.NewStructures_each_sublattice.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">settings</span><span class="p">,</span><span class="n">generation_number</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">struct_per_gen</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span><span class="n">check_db</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">check_db</span> <span class="o">=</span> <span class="n">check_db</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span>   <span class="o">=</span> <span class="n">config</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">corrfunc</span> <span class="o">=</span> <span class="n">CorrFunction_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">struct_per_gen</span> <span class="o">=</span> <span class="n">struct_per_gen</span>

		<span class="k">if</span> <span class="n">generation_number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_gen_number</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">generation_number</span></div>


<div class="viewcode-block" id="NewStructures_each_sublattice.generate_probe_structure">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.NewStructures_each_sublattice.generate_probe_structure">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">generate_probe_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">final_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_temp</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_steps_per_temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">approx_mean_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_samples_var</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">approx_mean_var</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;probe_structure-sigma_mu.npz&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_generate_sigma_mu</span><span class="p">(</span><span class="n">num_samples_var</span><span class="p">)</span>

		<span class="n">current_count</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">num_attempt</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">num_to_generate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_to_gen</span><span class="p">()</span>

		<span class="k">while</span> <span class="n">current_count</span> <span class="o">&lt;</span> <span class="n">num_to_generate</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">set_active_template</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">)</span>
			<span class="n">num_struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_in_gen</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">num_struct</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_per_gen</span><span class="p">:</span>
				<span class="k">break</span>

			<span class="n">struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_struct_at_conc</span><span class="p">(</span><span class="n">conc_type</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">)</span>

			<span class="n">ps</span> <span class="o">=</span> <span class="n">ProbeStructure_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">struct</span><span class="p">,</span><span class="n">init_temp</span><span class="p">,</span><span class="n">final_temp</span><span class="p">,</span><span class="n">num_temp</span><span class="p">,</span><span class="n">num_steps_per_temp</span><span class="p">,</span><span class="n">approx_mean_var</span><span class="p">)</span>
			<span class="n">probe_struct</span><span class="p">,</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>

			<span class="n">probe_struct</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;energy&quot;</span><span class="p">)</span>
			<span class="n">formula_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_formula_unit</span><span class="p">(</span><span class="n">probe_struct</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists_in_db</span><span class="p">(</span><span class="n">probe_struct</span><span class="p">,</span> <span class="n">formula_unit</span><span class="p">):</span>
				<span class="n">num_attempt</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">if</span> <span class="n">num_attempt</span> <span class="o">&gt;=</span> <span class="n">max_attempt</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">MaxAttemptReachedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">num_attempt</span> <span class="o">=</span> <span class="mi">0</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">insert_structure</span><span class="p">(</span><span class="n">init_struct</span><span class="o">=</span><span class="n">probe_struct</span><span class="p">,</span> <span class="n">cf</span><span class="o">=</span><span class="n">cf</span><span class="p">)</span>
			<span class="n">current_count</span> <span class="o">+=</span> <span class="mi">1</span></div>
</div>


<span class="kn">from</span><span class="w"> </span><span class="nn">clease.structgen</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbeStructure</span>
<span class="c1"># import CorrFunction_each_sublattice</span>

<div class="viewcode-block" id="ProbeStructure_each_sublattice">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ProbeStructure_each_sublattice">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProbeStructure_each_sublattice</span><span class="p">(</span><span class="n">ProbeStructure</span><span class="p">):</span>
<div class="viewcode-block" id="ProbeStructure_each_sublattice.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ProbeStructure_each_sublattice.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">settings</span><span class="p">,</span><span class="n">atoms</span><span class="p">,</span><span class="n">init_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">final_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">num_temp</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">num_steps_per_temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">approx_mean_var</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="n">ProbeStructure</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">init_temp</span><span class="p">,</span> <span class="n">final_temp</span><span class="p">,</span> <span class="n">num_temp</span><span class="p">,</span> <span class="n">num_steps_per_temp</span><span class="p">,</span> <span class="n">approx_mean_var</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">corrFunc</span> <span class="o">=</span> <span class="n">CorrFunction_each_sublattice</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span></div>
</div>


<span class="kn">from</span><span class="w"> </span><span class="nn">clease.corr_func</span><span class="w"> </span><span class="kn">import</span> <span class="n">CorrFunction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase</span><span class="w"> </span><span class="kn">import</span> <span class="n">Atoms</span>
<span class="c1"># import cf_calculator_each_sublattice</span>

<div class="viewcode-block" id="CorrFunction_each_sublattice">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CorrFunction_each_sublattice">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CorrFunction_each_sublattice</span><span class="p">(</span><span class="n">CorrFunction</span><span class="p">):</span>
<div class="viewcode-block" id="CorrFunction_each_sublattice.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CorrFunction_each_sublattice.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">settings</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span>   <span class="o">=</span> <span class="n">config</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span></div>


<div class="viewcode-block" id="CorrFunction_each_sublattice.get_cf_by_names">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CorrFunction_each_sublattice.get_cf_by_names">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_cf_by_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">cf_names</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">Atoms</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">set_template</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;atoms must be Atoms object&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_confirm_cf_names_exists</span><span class="p">(</span><span class="n">cf_names</span><span class="p">)</span>

		<span class="n">cf</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cf_names</span><span class="p">}</span>
		<span class="n">cf</span> <span class="o">=</span> <span class="n">cf_calculator_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">atoms</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span><span class="n">cf</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cf</span></div>
</div>


<div class="viewcode-block" id="check_position_overlap">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.check_position_overlap">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_position_overlap</span><span class="p">(</span><span class="n">new</span><span class="p">,</span><span class="n">reference</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-1</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">positions</span><span class="o">-</span><span class="n">reference</span><span class="o">.</span><span class="n">positions</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input model is not the same structure of the target model.&quot;</span><span class="p">)</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w">  </span><span class="nn">np</span>

<div class="viewcode-block" id="check_max_cluster_size">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.check_max_cluster_size">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_max_cluster_size</span><span class="p">(</span><span class="n">prim_model</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">max_cluster_size</span><span class="p">):</span>
	<span class="n">adjacent_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
	<span class="n">adjacent_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
	<span class="n">adjacent_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="n">adjacent_mask</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
	<span class="n">adjacent_mask</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="n">adjacent_mask</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
	<span class="n">adjacent_mask</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="n">model</span> <span class="o">=</span> <span class="n">prim_model</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
	<span class="n">adjacent_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">adjacent_mask</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cell</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
	<span class="n">adjacent_length</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">adjacent_length</span><span class="p">)</span>
	<span class="n">adjacent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">adjacent_length</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">adjacent_length</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
	<span class="n">adjacent_translate</span> <span class="o">=</span> <span class="n">adjacent</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cell</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
	<span class="n">adjacent_translate_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">adjacent_translate</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">adjacent_prim</span> <span class="o">=</span> <span class="n">prim_model</span><span class="o">.</span><span class="n">positions</span><span class="o">+</span><span class="n">adjacent_translate</span>
	<span class="n">extended_prim</span> <span class="o">=</span> <span class="n">prim_model</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">positions</span>
	<span class="n">adjacent_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">adjacent_prim</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">-</span><span class="n">extended_prim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># ここのまえにあまりに長すぎる距離(真逆とか)は丸めてもいいかも。2乗がえぐそう</span>
	<span class="n">prim_distance</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">prim_model</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">-</span><span class="n">extended_prim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">distance</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">adjacent_distance</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:],</span><span class="n">prim_distance</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]])</span>
	<span class="n">distance</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">criterion</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_cluster_size</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">criterion</span><span class="p">:</span> <span class="c1">## デバッグ的にはないほうがいいかも</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The max_cluster_size should be up to </span><span class="si">{</span><span class="n">criterion</span><span class="si">}</span><span class="s2"> Å (now: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">max_cluster_size</span><span class="p">)</span><span class="si">}</span><span class="s2"> Å). This setting leads to calculate ECIs for the same atom configuration between 2 or more clusters due to the periodic boundary condtion. Please reduce max_cluster_size or increase model size.&quot;</span><span class="p">)</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">ase</span><span class="w"> </span><span class="kn">import</span> <span class="n">Atom</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.build.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">sort</span>

<div class="viewcode-block" id="Slab_Processor">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Slab_Processor</span><span class="p">:</span>
<div class="viewcode-block" id="Slab_Processor.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cif_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">vacuum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">leyer_number</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">cif_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cif_list</span>         <span class="o">=</span> <span class="n">cif_list</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">radiusdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Au&#39;</span><span class="p">:</span><span class="mf">1.44</span><span class="p">,</span><span class="s1">&#39;Co&#39;</span><span class="p">:</span><span class="mf">1.25</span><span class="p">,</span><span class="s1">&#39;Pd&#39;</span><span class="p">:</span><span class="mf">1.37</span><span class="p">,</span><span class="s1">&#39;Zn&#39;</span><span class="p">:</span><span class="mf">1.37</span><span class="p">,</span><span class="s1">&#39;Fe&#39;</span><span class="p">:</span><span class="mf">1.26</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="mf">1.1</span><span class="p">,</span><span class="s1">&#39;Ce&#39;</span><span class="p">:</span><span class="mf">1.82</span><span class="p">,</span><span class="s1">&#39;Pt&#39;</span><span class="p">:</span><span class="mf">1.39</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">:</span><span class="mf">0.74</span><span class="p">,</span><span class="s1">&#39;Ba&#39;</span><span class="p">:</span><span class="mf">2.24</span><span class="p">,</span><span class="s1">&#39;Cu&#39;</span><span class="p">:</span><span class="mf">1.28</span><span class="p">,</span><span class="s1">&#39;Ni&#39;</span><span class="p">:</span><span class="mf">1.25</span><span class="p">,</span><span class="s1">&#39;Ru&#39;</span><span class="p">:</span><span class="mf">1.34</span><span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">atomcandidate</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span><span class="s2">&quot;C&quot;</span><span class="p">,</span><span class="s2">&quot;N&quot;</span><span class="p">,</span><span class="s2">&quot;O&quot;</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">model_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">set_model_type</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">vacuum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">set_vaccum_thickness</span><span class="p">(</span><span class="n">vacuum</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;vacuum&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">leyer_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">set_leyer_number</span><span class="p">(</span><span class="n">leyer_number</span><span class="p">)</span></div>


	<span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function_list</span><span class="p">,</span><span class="n">profix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fileformat</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">function_list</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">process_iter</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;cif&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">save_cif</span><span class="p">(</span><span class="n">profix</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;vasp&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">save_vasp</span><span class="p">(</span><span class="n">profix</span><span class="p">)</span>

<div class="viewcode-block" id="Slab_Processor.update_radiusdict">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.update_radiusdict">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">update_radiusdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">symbol</span><span class="p">,</span><span class="n">radius</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">radiusdict</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span></div>


<div class="viewcode-block" id="Slab_Processor.selective_dynamics">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.selective_dynamics">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">selective_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">POSCAR_list</span><span class="p">,</span><span class="n">adsorbate_number</span><span class="p">,</span><span class="n">fix_relax_list</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">POSCAR</span> <span class="ow">in</span> <span class="n">POSCAR_list</span><span class="p">:</span>
			<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">POSCAR</span><span class="p">)</span>
			<span class="n">split_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">-</span><span class="n">adsorbate_number</span><span class="p">)</span> <span class="o">*</span> <span class="n">fix_relax_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">fix_relax_list</span><span class="p">))</span>
			<span class="n">fixindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[:</span><span class="o">-</span><span class="n">adnum</span><span class="p">,</span><span class="mi">2</span><span class="p">])[:</span><span class="n">split_index</span><span class="p">]</span> <span class="c1"># 上下吸着物がにいても取ってこれる</span>
			<span class="n">relaxindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[:</span><span class="o">-</span><span class="n">adnum</span><span class="p">,</span><span class="mi">2</span><span class="p">])[</span><span class="n">split_index</span><span class="p">:]</span>
			<span class="n">adindex</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="n">adnum</span><span class="p">:,</span><span class="mi">2</span><span class="p">])</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultdir</span><span class="o">+</span><span class="s1">&#39;/POSCAR&#39;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">fix_relax_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
				<span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
					<span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fixindex</span><span class="o">+</span><span class="mi">9</span><span class="p">:</span>
						<span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; F F F </span><span class="se">\n</span><span class="s1">&#39;</span>
					<span class="k">elif</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">relaxindex</span><span class="o">+</span><span class="mi">9</span><span class="p">:</span>
						<span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; T T T </span><span class="se">\n</span><span class="s1">&#39;</span>
					<span class="k">elif</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">adindex</span><span class="o">+</span><span class="mi">9</span><span class="p">:</span>
						<span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; T T T </span><span class="se">\n</span><span class="s1">&#39;</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultdir</span><span class="o">+</span><span class="s1">&#39;/POSCAR&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="Slab_Processor.set_cif_list">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.set_cif_list">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">set_cif_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cif_list</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cif_list</span> <span class="o">=</span> <span class="n">cif_list</span></div>


<div class="viewcode-block" id="Slab_Processor.set_vaccum_thickness">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.set_vaccum_thickness">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">set_vaccum_thickness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span> <span class="o">=</span> <span class="n">vacuum_thickness</span></div>


<div class="viewcode-block" id="Slab_Processor.set_leyer_number">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.set_leyer_number">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">set_leyer_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">leyer_number</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">leyer_number</span> <span class="o">=</span> <span class="n">leyer_number</span></div>


<div class="viewcode-block" id="Slab_Processor.set_model_type">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.set_model_type">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">set_model_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model_type</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;slab&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">bottom_bool</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;sheet&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">bottom_bool</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Slab_Processor.load">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.load">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">cif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cif_list</span><span class="p">:</span>
			<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cif</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></div>


<div class="viewcode-block" id="Slab_Processor.save_cif">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.save_cif">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">save_cif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">profix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">cif_path</span><span class="p">,</span><span class="n">model</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cif_list</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">profix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cif_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">profix</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cif_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">)</span></div>


<div class="viewcode-block" id="Slab_Processor.save4visualize">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.save4visualize">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">save4visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">profix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">cif_path</span><span class="p">,</span><span class="n">model</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cif_list</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
			<span class="n">element_dict</span><span class="o">=</span><span class="p">{}</span>
			<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">element_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">element_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
			<span class="n">element_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">element_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
			<span class="n">element_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">+</span><span class="n">element</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">element_list</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">profix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cif_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">profix</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cif_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">)</span></div>


<div class="viewcode-block" id="Slab_Processor.save_vasp">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.save_vasp">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">save_vasp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">profix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">cif_path</span><span class="p">,</span><span class="n">model</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cif_list</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">profix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cif_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">profix</span><span class="si">}</span><span class="s2">.vasp&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cif_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">.vasp&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">)</span></div>


<div class="viewcode-block" id="Slab_Processor.process_iter">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.process_iter">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">process_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">function</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></div>


<div class="viewcode-block" id="Slab_Processor.sort">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.sort">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="Slab_Processor.remove_vacuum">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.remove_vacuum">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">remove_vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="n">cell</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span>
		<span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span><span class="p">)</span><span class="o">/</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
		<span class="n">model</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="Slab_Processor.add_vacuum">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.add_vacuum">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">add_vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="n">cell</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span>
		<span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span><span class="p">)</span><span class="o">/</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
		<span class="n">model</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="Slab_Processor.undo_z_wrap">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.undo_z_wrap">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">undo_z_wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leyer_number</span><span class="o">-</span><span class="mf">0.9</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">leyer_number</span><span class="p">:</span>
				<span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">z</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
			<span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">offset</span>
		<span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="Slab_Processor.adsorption_Hydrogen">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.adsorption_Hydrogen">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">adsorption_Hydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_moledule</span><span class="p">(</span><span class="n">model</span><span class="p">,[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">2.1</span><span class="p">]])</span></div>


<div class="viewcode-block" id="Slab_Processor.adsorption_Oxygen">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.adsorption_Oxygen">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">adsorption_Oxygen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_moledule</span><span class="p">(</span><span class="n">model</span><span class="p">,[[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">2.1</span><span class="p">]])</span></div>


<div class="viewcode-block" id="Slab_Processor.adsorption_Carbon">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.adsorption_Carbon">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">adsorption_Carbon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_moledule</span><span class="p">(</span><span class="n">model</span><span class="p">,[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">2.1</span><span class="p">]])</span></div>


<div class="viewcode-block" id="Slab_Processor.adsorption_CO">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.adsorption_CO">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">adsorption_CO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adsorption_moledule</span><span class="p">(</span><span class="n">model</span><span class="p">,[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">2.1</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">2.1</span><span class="o">+</span><span class="mf">1.18</span><span class="p">]])</span></div>


<div class="viewcode-block" id="Slab_Processor.adsorption_moledule">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.adsorption_moledule">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">adsorption_moledule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">adsorbate_data</span><span class="p">):</span>
		<span class="n">surface_judge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_surfaceatoms</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="n">top</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surfaceatoms</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">surface_judge</span><span class="p">)</span>
		<span class="n">admodel</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="n">vacuum</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">del</span> <span class="n">vacuum</span><span class="p">[:]</span>
		<span class="n">count</span><span class="o">=</span><span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">adsorbate_data</span><span class="p">:</span>
				<span class="n">vacuum</span><span class="o">+=</span><span class="n">Atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomcandidate</span><span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
				<span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_bool</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bottom</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">adsorbate_data</span><span class="p">:</span>
					<span class="n">vacuum</span><span class="o">+=</span><span class="n">Atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomcandidate</span><span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
					<span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
		<span class="n">elementlist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vacuum</span><span class="o">.</span><span class="n">get_chemical_symbols</span><span class="p">())</span>
		<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elementlist</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vacuum</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">symbol</span><span class="o">==</span><span class="n">element</span><span class="p">:</span>
					<span class="n">admodel</span><span class="o">+=</span><span class="n">Atom</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">admodel</span></div>


<div class="viewcode-block" id="Slab_Processor.search_surfaceatoms">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.search_surfaceatoms">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">search_surfaceatoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">original_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_expansion</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="n">atomradiuslist</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">radiusdict</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="p">]</span>
		<span class="n">atompositionlist</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="p">]</span>
		<span class="n">original_zlist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">)</span>
		<span class="n">surfacelist</span><span class="o">=</span><span class="p">[]</span>
		<span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
			<span class="n">target_radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radiusdict</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span><span class="o">+</span><span class="mf">1.11</span>
			<span class="n">zlists</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">target_radius</span><span class="o">*</span><span class="n">original_zlist</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original_zlist</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">xlists</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
			<span class="n">ylists</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
			<span class="n">xylists</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xlists</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xlists</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">ylists</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ylists</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">original_zlist</span><span class="p">))</span>
			<span class="n">ratiolist</span><span class="o">=</span><span class="p">(</span><span class="n">target_radius</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">zlists</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
			<span class="n">balllist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratiolist</span><span class="p">)</span><span class="o">*</span><span class="n">xylists</span><span class="p">,</span><span class="n">zlists</span><span class="p">))</span>

			<span class="n">positions</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">position</span><span class="o">+</span><span class="n">balllist</span>
			<span class="n">repeat_positions</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">atompositionlist</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">distance</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">repeat_positions</span><span class="o">-</span><span class="n">atompositionlist</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
			<span class="n">totalradius</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomradiuslist</span><span class="p">)</span><span class="o">+</span><span class="mf">1.1</span>
			<span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="n">totalradius</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
				<span class="n">surfacelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

		<span class="n">surface_judge</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">original_indices</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">surfacelist</span><span class="p">:</span>
				<span class="n">surface_judge</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
		<span class="k">return</span> <span class="n">surface_judge</span></div>


<div class="viewcode-block" id="Slab_Processor.model_expansion">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.model_expansion">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">model_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="n">expand_ratio</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">expand_ratio</span><span class="p">))</span>
		<span class="n">originalnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">expand_ratio</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">original_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">originalnum</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="p">(</span><span class="n">originalnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">model</span> <span class="o">*</span> <span class="n">expand_ratio</span>
		<span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">original_indices</span></div>


<div class="viewcode-block" id="Slab_Processor.get_surfaceatoms">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Slab_Processor.get_surfaceatoms">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_surfaceatoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">connectivity</span><span class="p">):</span>
		<span class="n">surf_atoms</span> <span class="o">=</span> <span class="n">connectivity</span> <span class="o">!=</span> <span class="mi">0</span>
		<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">surf_atoms</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
		<span class="n">relative_zcoords</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
		<span class="n">top</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">relative_zcoords</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
		<span class="n">bottom</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">relative_zcoords</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span></div>
</div>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">amplify_bbopt</span><span class="w"> </span><span class="kn">import</span> <span class="n">blackbox</span><span class="p">,</span> <span class="n">BinaryVariableList</span><span class="p">,</span> <span class="n">DatasetGenerator</span><span class="p">,</span> <span class="n">KernelQAOptimizer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">amplify_bbopt</span> <span class="c1"># equal_toのため。フォルダ分けでアニーリングのequal_toと被らなくなれば上に統合できる</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase</span><span class="w"> </span><span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.build</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_vacuum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">comb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.settings.concentration</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concentration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">CECrystal</span><span class="p">,</span><span class="n">CESlab</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.basis_function</span><span class="w"> </span><span class="kn">import</span> <span class="n">BasisFunction</span><span class="p">,</span> <span class="n">BinaryLinear</span><span class="p">,</span> <span class="n">Polynomial</span><span class="p">,</span> <span class="n">Trigonometric</span>
<span class="c1">#from clease.settings.settings_slab import remove_vacuum_layers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease.structgen</span><span class="w"> </span><span class="kn">import</span> <span class="n">NewStructures</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clease</span><span class="w"> </span><span class="kn">import</span> <span class="n">Evaluate</span>
<span class="c1">#import CESlab_nowarning</span>
<span class="c1">#import Calculator</span>
<span class="c1">#import NewStructures_each_sublattice</span>
<span class="c1"># import Fixstars_Amplify</span>

<span class="c1">##去年の時点で遅いとされていた実装などでもベーシックなら入れているので、今後元を参考にしつつCythonizeしていけ</span>
<div class="viewcode-block" id="ClusterExpansionExcutor">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ClusterExpansionExcutor</span><span class="p">():</span>
<div class="viewcode-block" id="ClusterExpansionExcutor.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">confirm_max_cluster_size</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		input:</span>
<span class="sd">			config: Prepare_Configクラスのもの。</span>
<span class="sd">			seed: 構造生成をそろえて比較したいとき用</span>
<span class="sd">		output:</span>
<span class="sd">			None</span>
<span class="sd">		description:</span>
<span class="sd">			CEの準備をします。</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">##こんなにいるか?フォルダ構成は考える, bulkはチェックが必要</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span>               <span class="o">=</span> <span class="n">config</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span>         <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">db_name</span>              <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;train_data/training_data.db&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">host</span>                 <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;train_data/&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">model_type</span>           <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">miller_index</span>         <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;miller&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span>     <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;vacuum&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">concentration</span>        <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;substitute_ratio&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span>        <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;group_index&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;supercell_multiple&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span>       <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;basis_function&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span>     <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;max_cluster_size&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span>       <span class="o">=</span> <span class="p">[]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;train_data_num&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;calculate_method&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">scoring_scheme</span>       <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;scoring_scheme&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nsplits</span>              <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;split_number&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span>       <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;fitting_scheme&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>                <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">annealing_machine</span>    <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculation&#39;</span><span class="p">,</span><span class="s1">&#39;annealing_machine&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">confirm_cluster_size</span> <span class="o">=</span> <span class="n">confirm_max_cluster_size</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span>           <span class="o">=</span> <span class="n">Calculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
			<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
		<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">ranges</span>         <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">substitution</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">substitution</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
			<span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span><span class="n">substitution</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
					<span class="n">grouped_basis</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)))]</span>
				<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="o">=</span><span class="n">grouped_basis</span><span class="p">)</span>
				<span class="n">concentration</span><span class="o">.</span><span class="n">set_conc_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">)</span>
				<span class="n">output_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;symmetry.json&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
					<span class="n">symmetry_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">CECrystal</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span><span class="n">spacegroup</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group symbol&#39;</span><span class="p">]),</span>\
											<span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(),</span><span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()[:],</span>\
											<span class="n">basis_func_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="p">,</span><span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span>\
											<span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">,</span><span class="n">max_cluster_dia</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">,</span>\
											<span class="n">crystal_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;onduplicates&quot;</span><span class="p">:</span> <span class="s2">&quot;keep&quot;</span><span class="p">})</span> <span class="c1"># no crystal_kwargs leads to print user warning {symmetry sites in self.host} times. </span>
				<span class="k">if</span> <span class="n">confirm_max_cluster_size</span><span class="p">:</span>
					<span class="n">check_max_cluster_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_mng</span><span class="o">.</span><span class="n">prim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span><span class="o">&lt;</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">):</span> <span class="c1">## slab from bulkのみしかまだ考えていない</span>
					<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: vacuum @ config should be larger than maximum max_cluster_size @ config to avoid generating interaction between topmost layer and bottom layer through the vacuum layer.&quot;</span><span class="p">)</span>
					<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vacuum @ config set to maximum max_cluster_size+1 @ config.&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
					<span class="c1">##config自体も書き換えたほうがユーザーライク?</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">CESlab_nowarning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">miller_index</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">ranges</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span><span class="p">,</span><span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>\
											<span class="n">basis_func_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="p">,</span><span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span><span class="n">max_cluster_dia</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">confirm_max_cluster_size</span><span class="p">:</span>
					<span class="n">check_max_cluster_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_mng</span><span class="o">.</span><span class="n">prim</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
					<span class="n">grouped_basis</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)))]</span>
				<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="o">=</span><span class="n">grouped_basis</span><span class="p">)</span>
				<span class="n">concentration</span><span class="o">.</span><span class="n">set_conc_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">)</span>
				<span class="n">output_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;symmetry.json&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
					<span class="n">symmetry_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">CECrystal</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span><span class="n">spacegroup</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group symbol&#39;</span><span class="p">]),</span>\
											<span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(),</span><span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()[:],</span>\
											<span class="n">basis_func_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="p">,</span><span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span>\
											<span class="n">supercell_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">max_cluster_dia</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">,</span>\
											<span class="n">crystal_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;onduplicates&quot;</span><span class="p">:</span> <span class="s2">&quot;keep&quot;</span><span class="p">})</span> <span class="c1"># no crystal_kwargs leads to print user warning {symmetry sites in self.host} times. </span>
				<span class="k">if</span> <span class="n">confirm_max_cluster_size</span><span class="p">:</span>
					<span class="n">check_max_cluster_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_mng</span><span class="o">.</span><span class="n">prim</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;do not support </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">)</span><span class="si">}</span><span class="s2">-sized supercell_multiple for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2"> mode&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;do not support </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">)</span><span class="si">}</span><span class="s2">-sized supercell_multiple&quot;</span><span class="p">)</span>
		<span class="n">element_candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,[]))))</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="s2">&quot;energy_data.csv&quot;</span><span class="p">):</span>
			<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="s2">&quot;energy_per_atom&quot;</span><span class="p">,</span><span class="s2">&quot;formation_energy&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">element_candidates</span><span class="p">)</span>
			<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="s2">&quot;energy_data.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.reload_config">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.reload_config">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">reload_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This function with bulk has not implemented yet.&quot;</span><span class="p">)</span>
		<span class="n">symmetry_tolerance</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;symmetry_tolerance&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
		<span class="k">if</span> <span class="mf">1e-4</span> <span class="o">&gt;</span> <span class="n">symmetry_tolerance</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The decimals of cif data is usually 5. The symmetry_tolerance should be a order less than the decimals.&quot;</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">confirm_max_cluster_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confirm_cluster_size</span><span class="p">)</span>
		<span class="n">model_id_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="s2">&quot;id*.cif&quot;</span><span class="p">):</span>
			<span class="n">model_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">candidate</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">model_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">set</span><span class="p">(</span><span class="n">model_id_list</span><span class="p">)))</span>
		<span class="n">model_id_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">model_id_list</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">add_user_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update_formation_energy</span><span class="p">()</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.model_addition_random">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.model_addition_random">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">model_addition_random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">generation_number</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">training_data_generator</span> <span class="o">=</span> <span class="n">NewStructures_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">generation_number</span><span class="o">=</span><span class="n">generation_number</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span><span class="p">)</span>
		<span class="n">training_data_generator</span><span class="o">.</span><span class="n">generate_initial_pool</span><span class="p">()</span>

		<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
			<span class="n">atom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toatoms</span><span class="p">()</span>
			<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">atom</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.add_user_structure">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.add_user_structure">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">add_user_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Atoms</span><span class="p">):</span>
			<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="n">z</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">z</span><span class="p">:</span>
				<span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
		<span class="n">z</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span> <span class="c1"># そもそも複数サイトで働かない?⇒basis groupを考える必要。, 酸化物表面も重要。</span>
			<span class="n">atom</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span> <span class="c1"># 高さでtag</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">wrap_and_sort_by_position</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">template_atoms</span><span class="o">.</span><span class="n">weighted_random_template</span><span class="p">()</span>
		<span class="n">template</span> <span class="o">=</span> <span class="n">wrap_and_sort_by_position</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
		<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sorted_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">indices</span><span class="p">]</span>
		<span class="n">check_position_overlap</span><span class="p">(</span><span class="n">sorted_model</span><span class="p">,</span><span class="n">template</span><span class="p">)</span>
		<span class="n">sorted_model</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">positions</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">##sublatticeが無ければcfでsublatticeの考慮不要</span>
			<span class="n">data_inserter</span> <span class="o">=</span> <span class="n">NewStructures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">data_inserter</span> <span class="o">=</span> <span class="n">NewStructures_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span><span class="p">)</span>
		<span class="n">data_inserter</span><span class="o">.</span><span class="n">insert_structure</span><span class="p">(</span><span class="n">sorted_model</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="n">cf</span><span class="p">)</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
			<span class="n">atom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toatoms</span><span class="p">()</span>
			<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">atom</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.add_further_model">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.add_further_model">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">add_further_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">struct_per_gen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">generation_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>\
						<span class="n">init_temp</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">final_temp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_temp</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">num_steps_per_temp</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">random_composition</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ECI_file_name</span><span class="o">=</span><span class="s2">&quot;ECI.json&quot;</span><span class="p">):</span>
		<span class="n">training_data_generator</span> <span class="o">=</span> <span class="n">NewStructures_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">generation_number</span><span class="o">=</span><span class="n">generation_number</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="n">struct_per_gen</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;ground_state&quot;</span><span class="p">:</span>
			<span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">template_atoms</span><span class="o">.</span><span class="n">weighted_random_template</span><span class="p">()</span>
			<span class="n">template</span> <span class="o">=</span> <span class="n">wrap_and_sort_by_position</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
			<span class="n">eci_dict</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ECI</span><span class="p">(</span><span class="n">ECI_file_name</span><span class="p">)):</span>
				<span class="n">eci_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
			<span class="n">training_data_generator</span><span class="o">.</span><span class="n">generate_gs_structure</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">init_temp</span><span class="o">=</span><span class="n">init_temp</span><span class="p">,</span> <span class="n">final_temp</span><span class="o">=</span><span class="n">final_temp</span><span class="p">,</span> <span class="n">num_temp</span><span class="o">=</span><span class="n">num_temp</span><span class="p">,</span> <span class="n">num_steps_per_temp</span><span class="o">=</span><span class="n">num_steps_per_temp</span><span class="p">,</span> <span class="n">eci</span><span class="o">=</span><span class="n">eci_dict</span><span class="p">,</span> <span class="n">random_composition</span><span class="o">=</span><span class="n">random_composition</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;different&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The validation of structure (whether the most far from ex-models or not) has not confirmed yet.&quot;</span><span class="p">)</span>
			<span class="n">training_data_generator</span><span class="o">.</span><span class="n">generate_probe_structure</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> is not supported in this version of SurfQit.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.add_user_structure_origin">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.add_user_structure_origin">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">add_user_structure_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span> <span class="c1"># 今使っていないかも?</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Atoms</span><span class="p">):</span>
			<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="n">model</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span>
		<span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">template_atoms</span><span class="o">.</span><span class="n">weighted_random_template</span><span class="p">()</span>
		<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sorted_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">indices</span><span class="p">]</span>
		<span class="n">check_position_overlap</span><span class="p">(</span><span class="n">sorted_model</span><span class="p">,</span><span class="n">template</span><span class="p">)</span>
		<span class="n">sorted_model</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">positions</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">##sublatticeが無ければcfでsublatticeの考慮不要</span>
			<span class="n">data_inserter</span> <span class="o">=</span> <span class="n">NewStructures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">data_inserter</span> <span class="o">=</span> <span class="n">NewStructures_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span><span class="p">)</span>
		<span class="n">data_inserter</span><span class="o">.</span><span class="n">insert_structure</span><span class="p">(</span><span class="n">sorted_model</span><span class="p">)</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
			<span class="n">atom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toatoms</span><span class="p">()</span>
			<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">atom</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">)</span></div>

			
<div class="viewcode-block" id="ClusterExpansionExcutor.unconverged_calculate">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.unconverged_calculate">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">unconverged_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;csv_read&quot;</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">constraint_dict</span><span class="p">)</span> <span class="c1"># 計算を行う</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update_formation_energy</span><span class="p">()</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.update_formation_energy">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.update_formation_energy">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">update_formation_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">csv_write_formationE</span><span class="p">()</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">csv_read</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># formation_energyでアップデートする</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.calculate">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.calculate">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># return energyをやめた(のでCalculatorもreturn消している) ## 関数説明しろ　dictは{&quot;constraint&quot;:[],&quot;filter&quot;:{&quot;function&quot;:function,&quot;args&quot;:[引数たち]}}</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;single_point&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">single_point</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;optimization&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">optimization</span><span class="p">,</span><span class="n">constraint_dict</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculation type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not impremented&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.ECI_evaluate">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.ECI_evaluate">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">ECI_evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ECI_file_name</span><span class="o">=</span><span class="s2">&quot;ECI.json&quot;</span><span class="p">,</span><span class="n">CV_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="c1">## polynomial以外はここでエラーが出るはず。reconstructionでは治らなかった</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluate</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">scoring_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scoring_scheme</span><span class="p">,</span><span class="n">nsplits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsplits</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="o">==</span><span class="s2">&quot;linear&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">set_fitting_scheme</span><span class="p">(</span><span class="n">fitting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">CV_filename</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">set_fitting_scheme</span><span class="p">(</span><span class="n">fitting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="p">)</span>
			<span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">plot_CV</span><span class="p">(</span><span class="n">alpha_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">set_fitting_scheme</span><span class="p">(</span><span class="n">fitting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">set_fitting_scheme</span><span class="p">(</span><span class="n">fitting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="p">)</span>
			<span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">plot_CV</span><span class="p">(</span><span class="n">alpha_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">savefig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="n">CV_filename</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">set_fitting_scheme</span><span class="p">(</span><span class="n">fitting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
		<span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_cv_score</span><span class="p">()</span><span class="o">*</span><span class="mf">1000.0</span>
		<span class="k">if</span> <span class="n">cv</span> <span class="o">&gt;=</span> <span class="mf">5.0</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Your CV score is more than 5 meV/atom. (</span><span class="si">{</span><span class="n">cv</span><span class="si">}</span><span class="s2">) You should change CE conditions or/and increase the number of model.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">save_eci</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="n">ECI_file_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cv</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.ECI_evaluate_with_cf_optimization">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.ECI_evaluate_with_cf_optimization">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">ECI_evaluate_with_cf_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_cf_num</span><span class="p">,</span> <span class="n">ECI_file_name</span><span class="o">=</span><span class="s2">&quot;ECI.json&quot;</span><span class="p">,</span><span class="n">CV_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">init_sample</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">sample</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annealing_machine</span> <span class="o">!=</span> <span class="s2">&quot;FA&quot;</span><span class="p">:</span> 
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This version of SurfQit does not support the cf optimization except for Fixstars Amplify.&quot;</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CV score by full set of clusters: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ECI_evaluate</span><span class="p">(</span><span class="n">ECI_file_name</span><span class="p">,</span><span class="n">CV_filename</span><span class="p">))</span>
		<span class="n">full_cf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ECI</span><span class="p">(</span><span class="n">ECI_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

		<span class="nd">@blackbox</span>
		<span class="k">def</span><span class="w"> </span><span class="nf">objective_lowest_CV</span><span class="p">(</span><span class="n">cf_bool_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">BinaryVariableList</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_cf</span><span class="p">)))</span><span class="o">-&gt;</span><span class="nb">float</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reload_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">full_cf</span><span class="p">[</span><span class="n">cf_bool_list</span><span class="p">])</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ECI_evaluate</span><span class="p">(</span><span class="n">ECI_file_name</span><span class="p">,</span><span class="n">CV_filename</span><span class="p">)</span>

		<span class="n">objective_lowest_CV</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">amplify_bbopt</span><span class="o">.</span><span class="n">equal_to</span><span class="p">(</span><span class="n">objective_lowest_CV</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">cf_bool_list</span><span class="o">.</span><span class="n">to_poly</span><span class="p">(),</span><span class="nb">float</span><span class="p">(</span><span class="n">max_cf_num</span><span class="p">)))</span>
		<span class="n">generator</span>         <span class="o">=</span> <span class="n">DatasetGenerator</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="n">objective_lowest_CV</span><span class="p">)</span>
		<span class="n">data</span>              <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="n">init_sample</span><span class="p">)</span>
		<span class="n">FA</span>                <span class="o">=</span> <span class="n">Fixstars_Amplify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># QUBOのアニールと設定を共通させるのはいつか不都合が出るかも</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cf_optimizer</span> <span class="o">=</span> <span class="n">KernelQAOptimizer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">objective</span><span class="o">=</span><span class="n">objective_lowest_CV</span><span class="p">,</span><span class="n">client</span><span class="o">=</span><span class="n">FA</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">additional_cf_optimization</span><span class="p">(</span><span class="n">ECI_file_name</span><span class="p">,</span><span class="n">CV_filename</span><span class="p">,</span><span class="n">sample</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.additional_cf_optimization">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.additional_cf_optimization">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">additional_cf_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ECI_file_name</span><span class="p">,</span><span class="n">CV_filename</span><span class="p">,</span><span class="n">sample</span><span class="p">):</span>
		<span class="n">full_cf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ECI</span><span class="p">(</span><span class="n">ECI_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cf_optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">num_cycles</span><span class="o">=</span><span class="n">sample</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reload_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">full_cf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cf_optimizer</span><span class="o">.</span><span class="n">best_solution</span><span class="p">[</span><span class="s2">&quot;cf_bool_list&quot;</span><span class="p">]])</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optimized set of clusters: &quot;</span><span class="p">,</span> <span class="n">full_cf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cf_optimizer</span><span class="o">.</span><span class="n">best_solution</span><span class="p">[</span><span class="s2">&quot;cf_bool_list&quot;</span><span class="p">]])</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CV score by optimized set of clusters: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ECI_evaluate</span><span class="p">(</span><span class="n">ECI_file_name</span><span class="p">,</span><span class="n">CV_filename</span><span class="p">))</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.get_ECI">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.get_ECI">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_ECI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ECI_file_name</span><span class="o">=</span><span class="s2">&quot;ECI.json&quot;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">load_eci</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="n">ECI_file_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">cf_names</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">eci</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.get_basis_function">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.get_basis_function">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_basis_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unique_element</span><span class="p">):</span>
		<span class="c1"># a basis built for a type of substitution (same element variety)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;polynomial&quot;</span><span class="p">:</span>
			<span class="n">basis_funcion</span> <span class="o">=</span> <span class="n">Polynomial</span><span class="p">(</span><span class="n">unique_element</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;trigonometric&quot;</span><span class="p">:</span>
			<span class="n">basis_funcion</span> <span class="o">=</span> <span class="n">Trigonometric</span><span class="p">(</span><span class="n">unique_element</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;binary_linear&quot;</span><span class="p">:</span>
			<span class="n">basis_function</span> <span class="o">=</span> <span class="n">BinaryLinear</span><span class="p">(</span><span class="n">unique_element</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;basis function type </span><span class="si">{</span><span class="n">bf_type</span><span class="si">}</span><span class="s2"> is not supported.&quot;</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">basis_funcion</span></div>


<div class="viewcode-block" id="ClusterExpansionExcutor.make_qubit">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.make_qubit">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">make_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">## tag設定の観点からここでmodelを受け入れるのは無理?</span>
		<span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">supercell_multiple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">!=</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
				<span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">prim_cell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			
			<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">supercell_multiple</span><span class="p">)</span>
			<span class="n">model</span> <span class="o">=</span> <span class="n">wrap_and_sort_by_position</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">QUBO_model</span> <span class="o">=</span> <span class="n">model</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This bulk system has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()))</span><span class="si">}</span><span class="s2"> types of inequivalent sites, &quot;</span><span class="p">,</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()))</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;If this result is different from your intention, please set tag for each atom of the bulk.&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input model does not have specific tag corresponding to symmetrical equivalent sites.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]:</span>
			<span class="n">grouped_tag</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">]))]</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1">## まだ直していない</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This version of SurfQit does not support the multi site.&quot;</span><span class="p">)</span>
			<span class="n">grouped_basis</span> <span class="o">=</span> <span class="n">CE</span><span class="o">.</span><span class="n">grouped_basis</span> <span class="c1">## CE.grouped_basisがそもそもtagになっていないが、広げた後に対応させるためにtagに対応させる必要がある。</span>
		<span class="n">basis_dict</span> <span class="o">=</span><span class="p">{}</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;ここをtagで管理する&quot;&quot;&quot;</span> <span class="c1">## 実際にはCE.basis_elementsは&quot;all&quot;以外でtagに対応してないので外部で処理の必要</span>
		<span class="k">for</span> <span class="n">elements</span><span class="p">,</span><span class="n">tags</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_tag</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
				<span class="n">basis_dict</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">elements</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
		<span class="n">qubit_dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">qubit_index</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">qubits</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
				<span class="n">qubits</span> <span class="o">=</span> <span class="p">[</span><span class="n">qubit_index</span><span class="p">]</span>
				<span class="n">qubit_index</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The tag &#39;</span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39; is not corresponding to any basis.&quot;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">qubits</span> <span class="o">=</span> <span class="p">[</span><span class="n">qubit_index</span><span class="o">+</span><span class="n">addition</span> <span class="k">for</span> <span class="n">addition</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">]))]</span>
				<span class="n">qubit_index</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">])</span>
			<span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;variable_num&quot;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">]),</span><span class="s2">&quot;basis&quot;</span><span class="p">:</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">],</span><span class="s2">&quot;tag&quot;</span><span class="p">:</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span><span class="s2">&quot;qubits&quot;</span><span class="p">:</span><span class="n">qubits</span><span class="p">}</span>
		<span class="k">return</span> <span class="n">qubit_dict</span></div>

		<span class="c1">## bulkはindexをtagに反映していないかも知れないので、広げた後の対称性を明らかにするために,tagを設定するコードを作る。金属間化合物で検証</span>
		<span class="c1">## -&gt; self.tag2grouped_basisがそもそもない slabはbulk2slabでtagつけているし</span>

<div class="viewcode-block" id="ClusterExpansionExcutor.make_QUBO">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.make_QUBO">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">make_QUBO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">qubit_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ECI_file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">#Cythonizeをする必要がある</span>
		<span class="c1">## 3次以上で減らせそうなら変数を減らす</span>
		<span class="k">if</span> <span class="n">qubit_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">qubit_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_qubit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="n">dimension</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 4次も3次も次数下げで同じbit数になることを確認済み</span>
		<span class="k">if</span> <span class="n">dimension</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
			<span class="c1"># 実はここを消せばもっと高次にも対応しているが、一旦動作確認をplot_QUBOとかでしていないので開放していない</span>
			<span class="k">raise</span> <span class="n">NotImprementedError</span><span class="p">(</span><span class="s2">&quot;This version of SurfQit does not support HUBO for 5 or higher atoms cluster.&quot;</span><span class="p">)</span>
		<span class="n">basis_set</span>         <span class="o">=</span> <span class="p">{}</span> <span class="c1">## tag毎に構築する</span>
		<span class="k">for</span> <span class="n">qubit_info</span> <span class="ow">in</span> <span class="n">qubit_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basis_set</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="n">basis</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_basis_function</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">])</span>
				<span class="n">basis_set_unsort</span>  <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">get_basis_functions</span><span class="p">()</span>
				<span class="n">basis_set_origin</span>  <span class="o">=</span> <span class="p">[]</span>
				<span class="k">for</span> <span class="n">partial_basis_set</span> <span class="ow">in</span> <span class="n">basis_set_unsort</span><span class="p">:</span>
					<span class="n">partial_basis</span> <span class="o">=</span> <span class="p">{}</span>
					<span class="k">for</span> <span class="n">qubit_basis</span> <span class="ow">in</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]:</span>
						<span class="n">partial_basis</span><span class="p">[</span><span class="n">qubit_basis</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial_basis_set</span><span class="p">[</span><span class="n">qubit_basis</span><span class="p">]</span>
					<span class="n">basis_set_origin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partial_basis</span><span class="p">)</span>
				<span class="n">basis_array</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">phi_i_j</span> <span class="k">for</span> <span class="n">phi_i_j</span> <span class="ow">in</span> <span class="n">phi_i</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span> <span class="k">for</span> <span class="n">phi_i</span> <span class="ow">in</span> <span class="n">basis_set_origin</span><span class="p">])</span>
				<span class="n">basis_set</span><span class="p">[</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">basis_array</span>
		<span class="k">if</span> <span class="n">ECI_file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">cf_names</span><span class="p">,</span> <span class="n">ECIs</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ECI</span><span class="p">(</span><span class="n">ECI_file_name</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">cf_names</span><span class="p">,</span> <span class="n">ECIs</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ECI</span><span class="p">()</span>
		<span class="n">cf_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cf_names</span><span class="p">}</span>
		<span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">atoms</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">QUBO_model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This bulk system has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()))</span><span class="si">}</span><span class="s2"> types of inequivalent sites, &quot;</span><span class="p">,</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()))</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;If this result is different from your intention, please set tag for each atom of the bulk.&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input model does not have specific tag corresponding to symmetrical equivalent sites.&quot;</span><span class="p">)</span>
		<span class="n">atoms</span><span class="o">.</span><span class="n">set_atomic_numbers</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_tags</span><span class="p">())</span>
		<span class="n">cluster_index_dict</span> <span class="o">=</span> <span class="n">cluster2index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_mng</span><span class="o">.</span><span class="n">prim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_list</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span><span class="n">atoms</span><span class="p">)</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annealing_machine</span> <span class="o">==</span> <span class="s2">&quot;FA&quot;</span><span class="p">:</span> <span class="c1">## DA, Jijも作る?</span>
			<span class="n">max_qubit_index</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">qubit_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
				<span class="n">max_qubit_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_qubit_index</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;qubits&quot;</span><span class="p">]))</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">QUBO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">max_qubit_index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dimension</span><span class="p">))</span> <span class="c1">## ここからcythonize可能</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">QUBO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">max_qubit_index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dimension</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1">## ここからcythonize可能, float64だとメモリが足りない場合用。float16に落とすバージョンも作ってもいいかもしれないけど精度...</span>
		<span class="n">constant</span> <span class="o">=</span> <span class="mi">0</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annealing_machine</span> <span class="o">==</span> <span class="s2">&quot;FA&quot;</span><span class="p">:</span> <span class="c1">## DA, Jijも作る? Cythonize</span>
			<span class="c1">#print(&quot;1330&quot;,cf_names) # debugで重要。configで[1,1,3.5] などとmax cluster diaを決めたときに、見たくない次数が入っていないことと見たい次数が軽めのcf数で入っていることを確認できる。</span>
			<span class="k">for</span> <span class="n">ECI</span><span class="p">,</span> <span class="n">cf_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ECIs</span><span class="p">,</span><span class="n">cf_names</span><span class="p">):</span>
				<span class="n">cluster_name</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="n">cluster_indices</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="k">for</span> <span class="n">cluster_name_</span><span class="p">,</span> <span class="n">cluster_indices_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cluster_index_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">cluster_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
					<span class="k">if</span> <span class="n">cluster_name_</span> <span class="ow">in</span> <span class="n">cf_name</span><span class="p">:</span>
						<span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name_</span>
						<span class="n">cluster_indices</span> <span class="o">=</span> <span class="n">cluster_indices_</span>
				<span class="k">if</span> <span class="n">cluster_name</span> <span class="o">==</span> <span class="s2">&quot;c0&quot;</span><span class="p">:</span>
					<span class="n">constant</span> <span class="o">+=</span> <span class="n">ECI</span>
				<span class="k">elif</span> <span class="s2">&quot;c1_&quot;</span> <span class="ow">in</span> <span class="n">cluster_name</span> <span class="ow">or</span> <span class="s2">&quot;c1&quot;</span> <span class="o">==</span> <span class="n">cluster_name</span><span class="p">:</span> <span class="c1"># c11_みたいなものをはじいている。</span>
					<span class="n">basis</span> <span class="o">=</span> <span class="n">basis_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cluster_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])][</span><span class="nb">int</span><span class="p">(</span><span class="n">cf_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
					<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">cluster_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;tag&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cluster_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
						<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The tag of the model is invalid.&quot;</span><span class="p">)</span>
					<span class="c1"># 対称移動にかかわらず代入する値は同じ(tagは動かない)-&gt;先に作れるし、cluster_indices[0]の結果を援用できる</span>
					<span class="n">sub_QUBO</span>     <span class="o">=</span> <span class="n">ECI</span><span class="o">*</span><span class="p">(</span><span class="n">basis_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">cluster_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;tag&quot;</span><span class="p">])][</span><span class="nb">int</span><span class="p">(</span><span class="n">cf_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">basis_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">cluster_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;tag&quot;</span><span class="p">])][</span><span class="nb">int</span><span class="p">(</span><span class="n">cf_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_indices</span><span class="p">)</span>
					<span class="n">sub_constant</span> <span class="o">=</span> <span class="n">ECI</span><span class="o">*</span><span class="n">basis_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">cluster_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;tag&quot;</span><span class="p">])][</span><span class="nb">int</span><span class="p">(</span><span class="n">cf_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_indices</span><span class="p">)</span>
					<span class="n">sub_onehot</span>   <span class="o">=</span> <span class="n">ECI</span><span class="o">*</span><span class="n">basis_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cluster_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])][</span><span class="nb">int</span><span class="p">(</span><span class="n">cf_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),:]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_indices</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">cluster_index</span> <span class="ow">in</span> <span class="n">cluster_indices</span><span class="p">:</span>
						<span class="n">bit</span> <span class="o">=</span> <span class="n">qubit_dict</span><span class="p">[</span><span class="n">cluster_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;qubits&#39;</span><span class="p">]</span> <span class="c1"># cluster_indexのlenが1なことは確定している。</span>
						<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">## 基底が2つ</span>
							<span class="n">QUBO</span><span class="p">[</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">bit</span><span class="o">*</span><span class="n">dimension</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">sub_QUBO</span>
							<span class="n">constant</span>  <span class="o">+=</span> <span class="n">sub_constant</span>
						<span class="k">else</span><span class="p">:</span> <span class="c1">## 今はone hot</span>
							<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">bit_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bit</span><span class="p">):</span>
								<span class="n">QUBO</span><span class="p">[</span><span class="o">*</span><span class="nb">tuple</span><span class="p">([</span><span class="n">bit_num</span><span class="p">]</span><span class="o">*</span><span class="n">dimension</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">sub_onehot</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span> <span class="c1">##bulkはtagで取り出せない可能性がある。そもそもcf nameの名づけ方が違うし。チェックが必要。</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
						<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;SurfQit does not support bulk now.&quot;</span><span class="p">)</span>
					<span class="n">basis</span> <span class="o">=</span> <span class="kc">None</span>
					<span class="k">for</span> <span class="n">unit_basis</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">basis_set</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tag</span><span class="p">)][</span><span class="nb">int</span><span class="p">(</span><span class="n">basis_index</span><span class="p">)]</span> <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">basis_index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cluster_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">cf_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))]):</span>
						<span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
							<span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">unit_basis</span><span class="p">)</span>
						<span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">*</span><span class="n">unit_basis</span> <span class="c1"># np.multiplyは挙動が違うので冗長だがこのように書かざるを得ない, c2で01の元素のペアなら01を見ると値が入っている</span>
					<span class="n">trans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
					<span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
					<span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">trans</span><span class="p">)</span>
					<span class="n">dummy_sub</span>   <span class="o">=</span> <span class="n">basis</span><span class="o">*</span><span class="n">ECI</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_indices</span><span class="p">)</span>
					<span class="n">dummy_bit</span>   <span class="o">=</span> <span class="p">[]</span>
					<span class="n">dummy_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
					<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">cluster_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
						<span class="n">dummy_list</span> <span class="o">=</span> <span class="p">[]</span>
						<span class="k">for</span> <span class="n">qubit</span> <span class="ow">in</span> <span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;qubits&#39;</span><span class="p">]:</span>
							<span class="n">dummy_count</span> <span class="o">+=</span> <span class="mi">1</span>
							<span class="n">dummy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dummy_count</span><span class="p">))</span>
						<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;qubits&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
							<span class="n">dummy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dummy_count</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_dummy&quot;</span><span class="p">)</span> <span class="c1"># bitとは異なり、0番目が存在(bit=1)に対応。1番目がbit=0に対応。</span>
						<span class="n">dummy_bit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dummy_list</span><span class="p">)</span>
					<span class="n">sub_bit</span>      <span class="o">=</span> <span class="p">[</span><span class="n">qubit</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">cluster_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">qubit</span> <span class="ow">in</span> <span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;qubits&#39;</span><span class="p">]]</span>
					<span class="n">sub_QUBO</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">sub_bit</span><span class="p">)]</span><span class="o">*</span><span class="n">dimension</span><span class="p">))</span>
					<span class="n">sub_constant</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="k">for</span> <span class="n">dummy_index</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dummy_sub</span><span class="o">.</span><span class="n">shape</span><span class="p">]):</span> <span class="c1"># dummy_subは各原子が選ばれた時の代入値が、sub_QUBOは各bitに対応する代入値が、入っている。</span>
						<span class="n">dummy_count</span> <span class="o">=</span> <span class="mi">0</span>
						<span class="k">for</span> <span class="n">count</span><span class="p">,</span><span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dummy_index</span><span class="p">):</span>
							<span class="k">if</span> <span class="s2">&quot;_dummy&quot;</span> <span class="ow">in</span> <span class="n">dummy_bit</span><span class="p">[</span><span class="n">count</span><span class="p">][</span><span class="n">index</span><span class="p">]:</span> <span class="c1"># dummyが入っているとすればlenが1のものにappendで追加されているのでindexは必ず1</span>
								<span class="n">dummy_count</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="k">if</span> <span class="n">dummy_count</span> <span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">dummy_index</span><span class="p">):</span> <span class="c1"># 全部dummy, [0,...]がECIを、他が0を表すようにQUBOを作る</span>
							<span class="c1">#sub_QUBO     = np.zeros(tuple([len(sub_bit)]*dimension)) # 検証用</span>
							<span class="c1">#sub_constant = 0 # 検証用</span>
							<span class="n">sub_constant</span> <span class="o">+=</span> <span class="n">dummy_sub</span><span class="p">[</span><span class="o">*</span><span class="n">dummy_index</span><span class="p">]</span> <span class="c1">#ここ以下は1が入ってくるときにconstantが打ち消されるように(このECIが表現されるように)QUBOを構築</span>
							<span class="n">pair_atom_indices</span> <span class="o">=</span> <span class="p">[]</span>
							<span class="k">for</span> <span class="n">count</span><span class="p">,</span><span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dummy_index</span><span class="p">):</span>
								<span class="n">pair_atom_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dummy_bit</span><span class="p">[</span><span class="n">count</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
							<span class="n">pair_atom_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dimension</span><span class="o">+</span><span class="mi">1</span><span class="p">)}</span>
							<span class="k">for</span> <span class="n">pair_atom_index</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">pair_atom_indices</span><span class="p">,</span><span class="n">repeat</span><span class="o">=</span><span class="n">dimension</span><span class="p">):</span>
								<span class="n">pair_atom_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pair_atom_index</span><span class="p">)))]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_atom_index</span><span class="p">)</span>
<span class="w">							</span><span class="sd">&quot;&quot;&quot;安定動作版, debugをいろいろしても動くならこれは消す</span>
<span class="sd">							pair_atom_dict = {&quot;1&quot;:[],&quot;2&quot;:[],&quot;3&quot;:[],&quot;4&quot;:[]} # 今のところ4次までしかサポートしていないのでbitの種類は1~4しかあり得ない</span>
<span class="sd">							for pair_atom_index in itertools.product(pair_atom_indices,repeat=dimension):</span>
<span class="sd">								if len(set(pair_atom_index)) == 1:</span>
<span class="sd">									pair_atom_dict[&quot;1&quot;].append(pair_atom_index)</span>
<span class="sd">								elif len(set(pair_atom_index)) == 2:</span>
<span class="sd">									pair_atom_dict[&quot;2&quot;].append(pair_atom_index)</span>
<span class="sd">								elif len(set(pair_atom_index)) == 3:</span>
<span class="sd">									pair_atom_dict[&quot;3&quot;].append(pair_atom_index)</span>
<span class="sd">								elif len(set(pair_atom_index)) == 4:</span>
<span class="sd">									pair_atom_dict[&quot;4&quot;].append(pair_atom_index)</span>
<span class="sd">								else:</span>
<span class="sd">									raise NotImplementedError(&quot;This version of SurfQit is not support more than 5th order binary optimization problem.&quot;)</span>
<span class="sd">							&quot;&quot;&quot;</span>
							<span class="n">coefficients</span> <span class="o">=</span> <span class="p">{}</span>
							<span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dimension</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
								<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair_atom_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)])</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># 2元系だとpair_atom_dict[3]以降が何も無い(0or1なので)</span>
									<span class="n">pair_atom_index</span>    <span class="o">=</span> <span class="n">pair_atom_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
									<span class="n">coefficient</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
									<span class="n">coefficient</span><span class="p">[</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>                                                                               <span class="c1"># m^nのmの係数は1に決まっている</span>
									<span class="n">div</span> <span class="o">=</span> <span class="n">dim</span><span class="o">**</span><span class="nb">len</span><span class="p">(</span><span class="n">pair_atom_index</span><span class="p">)</span>                                                                      <span class="c1"># m^nを実際に計算</span>
									<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">coefficients</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>                                                               <span class="c1"># 下の次数からmと係数ベクトルを取ってくる</span>
										<span class="n">coefficient</span> <span class="o">-=</span> <span class="p">(</span><span class="n">comb</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>                               <span class="c1"># dimCmに係数をかけて引く(背反を取るため)</span>
										<span class="n">div</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dimension</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="nb">len</span><span class="p">(</span><span class="n">pair_atom_index</span><span class="p">))</span><span class="o">*</span><span class="n">comb</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="c1"># 背反を取った後の値を実際に計算, 係数にはそれぞれの底をn乗したものをかける</span>
									<span class="n">coefficients</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefficient</span>
									<span class="k">for</span> <span class="n">pair_atom_index</span>  <span class="ow">in</span> <span class="n">pair_atom_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)]:</span>
										<span class="n">sub_QUBO</span><span class="p">[</span><span class="o">*</span><span class="n">pair_atom_index</span><span class="p">]</span> <span class="o">+=</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">dim</span><span class="p">)</span><span class="o">*</span><span class="n">dummy_sub</span><span class="p">[</span><span class="o">*</span><span class="n">dummy_index</span><span class="p">]</span><span class="o">/</span><span class="n">div</span>
<span class="w">							</span><span class="sd">&quot;&quot;&quot;安定動作版, debugをいろいろしても動くならこれは消す&quot;&quot;&quot;</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">							for pair_atom_index in pair_atom_dict[&quot;1&quot;]:</span>
<span class="s2">								sub_QUBO[*pair_atom_index] -= dummy_sub[*dummy_index]</span>
<span class="s2">							for pair_atom_index in pair_atom_dict[&quot;2&quot;]:</span>
<span class="s2">								sub_QUBO[*pair_atom_index] += dummy_sub[*dummy_index]/(2**len(pair_atom_index)-2)</span>
<span class="s2">							for pair_atom_index in pair_atom_dict[&quot;3&quot;]:</span>
<span class="s2">								sub_QUBO[*pair_atom_index] -= dummy_sub[*dummy_index]/(3**len(pair_atom_index)-3*(2**len(pair_atom_index))+3)</span>
<span class="s2">								&quot;&quot;&quot;&quot;&quot;&quot;</span>
<span class="s2">								3^n(n次元)の入力について、</span>
<span class="s2">								1種類の係数を取る方法は3C1=3</span>
<span class="s2">								2種類の係数を取る方法は3C2=3通りの2種類の決め方があり、各次元にどっちを入れるかなので2^n, ただし、全部の次元がそろうと1種類になってしまうので最初と最後を除いて3*(2^n-2)</span>
<span class="s2">								3種類の係数を取る方法は背反なので3^n-3-(3*(2^n-2)) 検算: n=3の時 3! = 6</span>
<span class="s2">								さて、dummy_sub[*dummy_index]をaとおくと(各係数において、bitの組合せを考慮した時に)-aを作りたいが</span>
<span class="s2">								1種類の係数は3*-a</span>
<span class="s2">								2種類の係数は3*(2^n-2)*a/(2^n-2)</span>
<span class="s2">								なので、3種類の係数は-a/(3^n-3-(3*(2^n-2)))=-a/(3^n-3*(2^n)+3)</span>
<span class="s2">								&quot;&quot;&quot;&quot;&quot;&quot;</span>
<span class="s2">							for pair_atom_index in pair_atom_dict[&quot;4&quot;]:</span>
<span class="s2">								&quot;&quot;&quot;&quot;&quot;&quot;</span>
<span class="s2">								4^n(n次元)の入力について、3^n(n次元)の入力のアナロジーで</span>
<span class="s2">								1種類の係数を取る方法は4C1=4</span>
<span class="s2">								2種類の係数を取る方法は4C2=6通りの2種類の決め方があり、各次元にどっちを入れるかなので2^n, ただし、全部の次元がそろうと1種類になってしまうので最初と最後を除いて6*(2^n-2)</span>
<span class="s2">								3種類の係数を取る方法は4C3=4通りの3種類の決め方があり、ダブらせる係数を各次元にどれを入れるかなので3^n, ただし、全部の次元が2つ以下にそろう(3C2*2^n)のはダメ, 1つにそろうときは(1,2の1と1,3の1のように)ダブルカウントされているので3^n-3*2^n+3 検算: n=3の時27個中(1,1,n)が7個、なので(2,2,n)や(3,3,n)とは被りがないことを考えると6が出るはず</span>
<span class="s2">								4種類の係数を取る方法は背反なので4^n-4-6*(2^n-2)-4*(3^n-3*2^n+3)=4^n-4-6*2^n+12-4*3^n+12*2^n-12=4^n-4*3^n+6*2^n-4 検算: n=4の時 4! = 24</span>
<span class="s2">								さて、dummy_sub[*dummy_index]をaとおくと-aを作りたいが</span>
<span class="s2">								1種類の係数は4 * -a = -4a</span>
<span class="s2">								2種類の係数は6*(2^n-2) * +a/(2^n-2)=+6a</span>
<span class="s2">								3種類の係数は4*(3^n-3*2^n+3) * -a/(3^n-3*(2^n)+3) = -4a</span>
<span class="s2">								なので、4種類の係数は+aを作りたくて,+a/(4^n-4*3^n+6*2^n-4)</span>
<span class="s2">								&quot;&quot;&quot;&quot;&quot;&quot;</span>
<span class="s2">								sub_QUBO[*pair_atom_index] += dummy_sub[*dummy_index]/(4**len(pair_atom_index)-4*(3**len(pair_atom_index))+6*(2**len(pair_atom_index))-4)</span>
<span class="s2">								&quot;&quot;&quot;&quot;&quot;&quot;一般化のためのメモ</span>
<span class="s2">								アナロジーを利かせると5^nでは</span>
<span class="s2">								1種類の係数を取る方法は5C1通り</span>
<span class="s2">								2種類の係数を取る方法は5C2通りの2種類の決め方があり、各次元にどっちを入れるかなので2^n, ただし、全部の次元がそろうと1種類になってしまうので最初と最後を除いて10*(2^n-2)</span>
<span class="s2">								3種類の係数を取る方法は5C3通りの3種類の決め方があり、ダブらせる係数を各次元にどれを入れるかなので3^n, ただし、全部の次元が2つ以下にそろう(3C2*2^n)のはダメ, 1つにそろうときは(1,2の1と1,3の1のように)ダブルカウントされているので3^n-3*2^n+3 検算: n=3の時27個中(1,1,n)が7個、なので(2,2,n)や(3,3,n)とは被りがないことを考えると6が出るはず</span>
<span class="s2">								4種類の係数を取る方法は5C4通りの4種類の決め方があり、ダブらせる係数を各次元にどれを入れるかなので4^n, ただし、全部の次元が3つ以下にそろう(4C3*3^n)のはダメ, 2つ以下にそろうときは(1,2,3の1,2と1,2,4の1,2のように)ダブルカウントされているので+3C2*2^n*2(112か122か), 1つにそろうときは(1,2,3の1, 1,2,4の1, 1,3,4のように)トリプルカウントされているので-2*4C3; 4^n-4*3^n+6*2^n-4</span>
<span class="s2">								5種類の係数を取る方法は背反なので5^n-5-10*(2^n-2)-5*(3^n-3*2^n+3)-5*(4^n-4*3^n+6*2^n-4)=5^n-5-10*2^n+20-5*3^n+15*2^n-15-5*4^n+20*3^n-30*2^n+20=5^n-5*4^n+15*3^n-25*2^n+20</span>
<span class="s2">								なんか法則性がありそうだが、背反を取り続けるのがよさそう</span>
<span class="s2">								&quot;&quot;&quot;</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="c1">#sub_QUBO     = np.zeros(tuple([len(sub_bit)]*dimension)) # 検証用</span>
							<span class="c1">#sub_constant = 0 # 検証用</span>
							<span class="c1">#print(sub_QUBO,sub_constant,dummy_sub[*dummy_index],dummy_bit,dummy_index)</span>
							<span class="n">true_bits</span>  <span class="o">=</span> <span class="p">[]</span>
							<span class="n">false_bits</span> <span class="o">=</span> <span class="p">[]</span>
							<span class="k">for</span> <span class="n">count</span><span class="p">,</span><span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dummy_index</span><span class="p">):</span>
								<span class="k">if</span> <span class="s2">&quot;_dummy&quot;</span> <span class="ow">in</span> <span class="n">dummy_bit</span><span class="p">[</span><span class="n">count</span><span class="p">][</span><span class="n">index</span><span class="p">]:</span>
									<span class="n">false_bits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dummy_bit</span><span class="p">[</span><span class="n">count</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
								<span class="k">else</span><span class="p">:</span>
									<span class="n">true_bits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dummy_bit</span><span class="p">[</span><span class="n">count</span><span class="p">][</span><span class="n">index</span><span class="p">]))</span>
							<span class="n">sub_QUBO</span><span class="p">[</span><span class="o">*</span><span class="n">true_bits</span><span class="o">+</span><span class="p">[</span><span class="n">true_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">dimension</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">true_bits</span><span class="p">))]</span> <span class="o">+=</span> <span class="n">dummy_sub</span><span class="p">[</span><span class="o">*</span><span class="n">dummy_index</span><span class="p">]</span> <span class="c1"># 以下は影響を打ち消し</span>
							<span class="k">for</span> <span class="n">false_length</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">false_bits</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
								<span class="k">for</span> <span class="n">pair_atom_index</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">false_bits</span><span class="p">,</span><span class="n">false_length</span><span class="p">):</span>
									<span class="n">sub_QUBO</span><span class="p">[</span><span class="o">*</span><span class="n">true_bits</span><span class="o">+</span><span class="p">[</span><span class="n">true_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">dimension</span><span class="o">-</span><span class="n">false_length</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">true_bits</span><span class="p">))</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">pair_atom_index</span><span class="p">)]</span> <span class="o">+=</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">false_length</span><span class="p">)</span><span class="o">*</span><span class="n">dummy_sub</span><span class="p">[</span><span class="o">*</span><span class="n">dummy_index</span><span class="p">]</span>
<span class="w">							</span><span class="sd">&quot;&quot;&quot;安定動作版, debugをいろいろしても動くならこれは消す</span>
<span class="sd">							if len(false_bits) == 4:</span>
<span class="sd">								raise NotImplementedError(&quot;This version of SurfQit does not support the 5 =&lt; order QUBO.&quot;)</span>
<span class="sd">							if len(false_bits) == 3: # 4次までだと全てが1bitで表す場合の0になることはない(上で全て0の場合の処理はしている)。最大が3つ。</span>
<span class="sd">								# -1倍でいいのかは不明</span>
<span class="sd">								for pair_atom_index in itertools.combinations(false_bits,3):</span>
<span class="sd">									print(&quot;1456&quot;,pair_atom_index)</span>
<span class="sd">								sub_QUBO[*true_bits+false_bits] += -dummy_sub[*dummy_index]</span>
<span class="sd">							if len(false_bits) &gt;= 2: </span>
<span class="sd">								for pair_atom_index in itertools.combinations(false_bits,2):</span>
<span class="sd">									sub_QUBO[*true_bits+[true_bits[0]]*(dimension-2-len(true_bits))+list(pair_atom_index)] += dummy_sub[*dummy_index]</span>
<span class="sd">							if len(false_bits) &gt;= 1: </span>
<span class="sd">								for pair_atom_index in itertools.combinations(false_bits,1):</span>
<span class="sd">									sub_QUBO[*true_bits+[true_bits[0]]*(dimension-1-len(true_bits))+list(pair_atom_index)] += -dummy_sub[*dummy_index]</span>
<span class="sd">							&quot;&quot;&quot;</span>
					<span class="k">for</span> <span class="n">cluster_index</span> <span class="ow">in</span> <span class="n">cluster_indices</span><span class="p">:</span>
						<span class="n">bits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;qubits&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">cluster_index</span><span class="p">]))</span>
						<span class="n">constant</span> <span class="o">+=</span> <span class="n">sub_constant</span>
						<span class="k">for</span> <span class="n">bit_pair</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span><span class="n">repeat</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sub_QUBO</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
							<span class="n">sub_pair</span> <span class="o">=</span> <span class="p">[</span><span class="n">bits</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">bit_pair</span><span class="p">]</span>
							<span class="n">QUBO</span><span class="p">[</span><span class="o">*</span><span class="n">bit_pair</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sub_QUBO</span><span class="p">[</span><span class="o">*</span><span class="n">sub_pair</span><span class="p">]</span>
		<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;QUBO.npy&quot;</span><span class="p">,</span><span class="n">QUBO</span><span class="p">)</span>
		<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;constant.npy&quot;</span><span class="p">,</span><span class="n">constant</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QUBO</span><span class="p">,</span><span class="n">constant</span></div>
</div>


<span class="kn">import</span><span class="w"> </span><span class="nn">clease.plot_post_process</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pp</span>

<div class="viewcode-block" id="plot_fit">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.plot_fit">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_fit</span><span class="p">(</span><span class="n">evaluator</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="n">evaluator</span><span class="p">)</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">clease.plot_post_process</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pp</span>
<div class="viewcode-block" id="plot_ECIs">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.plot_ECIs">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_ECIs</span><span class="p">(</span><span class="n">evaluator</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">plot_eci</span><span class="p">(</span><span class="n">evaluator</span><span class="p">)</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<div class="viewcode-block" id="plot_QUBO">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.plot_QUBO">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_QUBO</span><span class="p">(</span><span class="n">data_paths</span><span class="p">,</span><span class="n">qubit_dict</span><span class="p">,</span><span class="n">QUBO</span><span class="p">,</span><span class="n">constant</span><span class="p">,</span><span class="n">csv_path</span><span class="p">):</span> <span class="c1"># 今はbinaryのみ</span>
	<span class="n">dimension</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">QUBO</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
	<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
	<span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_paths</span><span class="p">:</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">QUBO</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">atom</span><span class="p">,</span><span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">qubit_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;qubits&quot;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># 単純に[qubit_dict[index][&quot;basis&quot;].index(atom.symbol)]を代入するわけではない。QUBO作成では0側をTrue, 1側をFalseとしているため。ただし、現象論。具体的にどこで変わっているかが今のところよくわからない。</span>
				<span class="n">bit</span><span class="p">[</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;qubits&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">[</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">symbol</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">bit</span><span class="p">[</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;qubits&quot;</span><span class="p">][</span><span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">symbol</span><span class="p">)]]</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="n">y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span><span class="n">QUBO</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimension</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
			<span class="n">y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y_</span><span class="p">,</span><span class="n">bit</span><span class="p">)</span>
		<span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_</span><span class="o">+</span><span class="n">constant</span><span class="p">)</span>
		<span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">==</span><span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])][</span><span class="s2">&quot;formation_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">==</span><span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])][</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s2">&quot;bo&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">*</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()],[</span><span class="o">*</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()],</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s2">&quot;bo&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fit using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> data points.&quot;</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;E$_</span><span class="si">{QUBO}</span><span class="s2">$ (eV/atom)&quot;</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;E$_</span><span class="si">{DFT}</span><span class="s2">$ (eV/atom)&quot;</span><span class="p">)</span>
	<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="mi">1000</span>
	<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">e_range</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
		<span class="n">rmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">e_range</span>
		<span class="n">rmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">e_range</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">rmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
		<span class="n">rmax</span> <span class="o">=</span> <span class="mi">10</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">])</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
		<span class="mf">0.95</span><span class="p">,</span>
		<span class="mf">0.01</span><span class="p">,</span>
		<span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="sa">f</span><span class="s2">&quot;RMSE = </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> meV/atom&quot;</span><span class="p">,</span>
		<span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
		<span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
		<span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
		<span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">return</span> <span class="n">fig</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">amplify</span><span class="w"> </span><span class="kn">import</span> <span class="n">Solver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">amplify.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">FixstarsClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">amplify</span><span class="w"> </span><span class="kn">import</span> <span class="n">BinarySymbolGenerator</span><span class="p">,</span> <span class="n">BinaryQuadraticModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">amplify.constraint</span><span class="w"> </span><span class="kn">import</span> <span class="n">equal_to</span>

<div class="viewcode-block" id="Annealing_Machine_Converter">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Annealing_Machine_Converter">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Annealing_Machine_Converter</span><span class="p">():</span>
<div class="viewcode-block" id="Annealing_Machine_Converter.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Annealing_Machine_Converter.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">QUBO</span><span class="p">,</span><span class="n">constant</span><span class="p">,</span><span class="n">qubit_dict</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span>          <span class="o">=</span> <span class="n">config</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">QUBO</span>            <span class="o">=</span> <span class="n">QUBO</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">constant</span>        <span class="o">=</span> <span class="n">constant</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">qubit_dict</span>      <span class="o">=</span> <span class="n">qubit_dict</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">default_penalty</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Annealing_Machine_Converter.set_default_penalty">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Annealing_Machine_Converter.set_default_penalty">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">set_default_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">reference</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;cost_max&quot;</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;cost_max&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">default_penalty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">e_dft</span><span class="p">))</span>
		<span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;QUBO_max&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">default_penalty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">reference</span><span class="p">))</span><span class="o">*</span><span class="n">reference</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1"># 源さんに教えていただいた他の方法も実装予定, 目的関数を無くして制約関数だけにして解いてみると、重み係数の良し悪しを排除してどこが課題なのかを抽出することができると思われる。 制約問題として解いた最適解を目的関数のオブジェクトに入れてprint(f.evaluate(result.best.values)を実行し、その結果を上手くスケーリングして合わせると良いと思われる。→より良い方法として、duplicateを用いてその結果の平均値や最大値を使って設定する方法もある。</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This version of SurfQit does not support the this method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Annealing_Machine_Converter.bit2energy">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Annealing_Machine_Converter.bit2energy">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">bit2energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">QUBO</span><span class="p">,</span><span class="n">constant</span><span class="p">,</span><span class="n">bits</span><span class="p">):</span>
		<span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span><span class="n">QUBO</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">QUBO</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
			<span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span><span class="n">bits</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">constant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">energy</span> <span class="o">+=</span> <span class="n">constant</span>
		<span class="k">return</span> <span class="n">energy</span></div>


<div class="viewcode-block" id="Annealing_Machine_Converter.endcode_to_annealing_machine">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Annealing_Machine_Converter.endcode_to_annealing_machine">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">endcode_to_annealing_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span></div>


<div class="viewcode-block" id="Annealing_Machine_Converter.setting_constraints">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Annealing_Machine_Converter.setting_constraints">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">setting_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span></div>


<div class="viewcode-block" id="Annealing_Machine_Converter.run">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Annealing_Machine_Converter.run">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">substitute_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">penalty_multipliers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">pass</span></div>


<div class="viewcode-block" id="Annealing_Machine_Converter.decode_to_universal_style">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Annealing_Machine_Converter.decode_to_universal_style">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">decode_to_universal_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
		<span class="k">pass</span></div>
</div>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">amplify</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve</span><span class="p">,</span> <span class="n">BinarySymbolGenerator</span><span class="p">,</span> <span class="n">BinaryQuadraticModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">amplify.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">FixstarsClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">amplify.constraint</span><span class="w"> </span><span class="kn">import</span> <span class="n">equal_to</span><span class="p">,</span><span class="n">one_hot</span>


<div class="viewcode-block" id="Fixstars_Amplify">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Fixstars_Amplify">[ドキュメント]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Fixstars_Amplify</span><span class="p">(</span><span class="n">Annealing_Machine_Converter</span><span class="p">):</span>
<div class="viewcode-block" id="Fixstars_Amplify.__init__">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Fixstars_Amplify.__init__">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">QUBO</span><span class="p">,</span><span class="n">constant</span><span class="p">,</span><span class="n">qubit_dict</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">QUBO</span><span class="p">,</span><span class="n">constant</span><span class="p">,</span><span class="n">qubit_dict</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">FixstarsClient</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;annealing&quot;</span><span class="p">,</span><span class="s2">&quot;time_out&quot;</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># ms</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">token</span>              <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;annealing&quot;</span><span class="p">,</span><span class="s2">&quot;token&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">num_solves</span>                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;annealing&quot;</span><span class="p">,</span><span class="s2">&quot;trial&quot;</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>               <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Fixstars_Amplify.encode_to_annealing_machine">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Fixstars_Amplify.encode_to_annealing_machine">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">encode_to_annealing_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">binary_generator</span> <span class="o">=</span> <span class="n">BinarySymbolGenerator</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bits</span> <span class="o">=</span> <span class="n">binary_generator</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QUBO</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;過去のバージョン。特にもんだないなら消す</span>
<span class="sd">		if len(self.QUBO.shape)==2:</span>
<span class="sd">			QUBO = np.dot(np.dot(self.bits,self.QUBO),self.bits.T)</span>
<span class="sd">		elif len(self.QUBO.shape)==3:</span>
<span class="sd">			QUBO = np.dot(np.dot(self.bits,np.dot(self.bits,self.QUBO)),self.bits)</span>
<span class="sd">		elif len(self.QUBO.shape)==4:</span>
<span class="sd">			QUBO = np.dot(np.dot(self.bits,np.dot(self.bits,np.dot(self.bits,self.QUBO))),self.bits)</span>
<span class="sd">		else:</span>
<span class="sd">			raise NotImplementedError(&quot;Encoding more than 5D QUBO was not impremented.&quot;)</span>
<span class="sd">			# for文で処理可能なので将来やる</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">QUBO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bit2energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QUBO</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QUBO</span></div>


<div class="viewcode-block" id="Fixstars_Amplify.setting_constraints">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Fixstars_Amplify.setting_constraints">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">setting_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">substitute_dict</span><span class="p">):</span>
		<span class="c1"># TODO: Apply to multi constraints だめなconstraint</span>
		<span class="n">site_dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">element_dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">site</span><span class="p">,</span><span class="n">qubit_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qubit_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">site_dict</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;qubits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">element_index</span><span class="p">,</span><span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]):</span>
				<span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">])</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">element</span> <span class="o">==</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
					<span class="n">element_dict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;qubits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
				<span class="k">elif</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">])</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">element</span> <span class="o">==</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
					<span class="n">element_dict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;qubits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),[]]</span>
				<span class="k">elif</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="n">element_dict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;qubits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">element_index</span><span class="p">]],[]]</span>
				<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">])</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">element</span> <span class="o">==</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
					<span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;qubits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
						<span class="n">element_dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="c1"># bitも1</span>
				<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">])</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">element</span> <span class="o">==</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
					<span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;qubits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
						<span class="n">element_dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="c1"># bitも0</span>
				<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="n">element_dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;qubits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">element_index</span><span class="p">])</span> <span class="c1"># bitも0</span>
		<span class="n">site_constraint</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">element_constraint</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">site_list</span> <span class="ow">in</span> <span class="n">site_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
				<span class="n">constraint</span>  <span class="o">=</span> <span class="n">one_hot</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">bits</span><span class="p">[</span><span class="n">site_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">site_index</span> <span class="ow">in</span> <span class="n">site_list</span><span class="p">]))</span>
				<span class="n">site_constraint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">substitute_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">constraint</span>  <span class="o">=</span> <span class="n">equal_to</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bits</span><span class="p">[</span><span class="n">element_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">element_index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">element_dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span><span class="o">+</span>\
											<span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bits</span><span class="p">[</span><span class="n">element_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">element_index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">element_dict</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="mi">0</span><span class="p">])]),</span><span class="n">number</span><span class="p">)</span>
			<span class="n">element_constraint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">site_constraint</span><span class="p">,</span><span class="n">element_constraint</span><span class="p">]</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span></div>


<div class="viewcode-block" id="Fixstars_Amplify.run">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Fixstars_Amplify.run">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">penalty_multipliers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">substitute_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">QUBO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_to_annealing_machine</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">penalty_multipliers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">problem</span> <span class="o">=</span> <span class="n">QUBO</span>
		<span class="k">elif</span> <span class="n">penalty_multipliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">substitute_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setting_constraints</span><span class="p">(</span><span class="n">substitute_dict</span><span class="p">)</span>
			<span class="n">problem</span> <span class="o">=</span> <span class="n">QUBO</span>
			<span class="k">for</span> <span class="n">multiplier</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">penalty_multipliers</span><span class="p">,</span><span class="n">constraints</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">multiplier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="k">if</span> <span class="n">multiplier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">multiplier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_penalty</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
					<span class="k">for</span> <span class="n">same_condition_constraint</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
						<span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span> <span class="o">+</span> <span class="n">multiplier</span><span class="o">*</span><span class="n">same_condition_constraint</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span> <span class="o">+</span> <span class="n">multiplier</span><span class="o">*</span><span class="n">constraint</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please set both substitute_number and penalty_multipliers.&quot;</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span><span class="n">num_solves</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Fixstars_Amplify.decode_to_universal_style">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Fixstars_Amplify.decode_to_universal_style">[ドキュメント]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">decode_to_universal_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">results</span><span class="p">):</span>
		<span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">energy</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">energy_with_constraints</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">bits</span>   <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
			<span class="n">solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bits</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
			<span class="n">energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bit2energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QUBO</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">,</span><span class="n">solution</span><span class="p">))</span>
			<span class="n">energy_with_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">objective</span><span class="p">)</span>
			<span class="n">bits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
			<span class="n">result_dict</span><span class="p">[</span><span class="s2">&quot;best_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy</span><span class="p">))</span>
			<span class="n">result_dict</span><span class="p">[</span><span class="s2">&quot;best_bits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy</span><span class="p">))]</span>
			<span class="n">result_dict</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
			<span class="n">result_dict</span><span class="p">[</span><span class="s2">&quot;energy_with_constraints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_with_constraints</span>
			<span class="n">result_dict</span><span class="p">[</span><span class="s2">&quot;bits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span>
		<span class="k">return</span> <span class="n">result_dict</span></div>
</div>


<div class="viewcode-block" id="best_bits2model">
<a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.best_bits2model">[ドキュメント]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">best_bits2model</span><span class="p">(</span><span class="n">result_dict</span><span class="p">,</span><span class="n">ClusterExpansionExcutor</span><span class="p">):</span>
	<span class="n">model</span> <span class="o">=</span> <span class="n">ClusterExpansionExcutor</span><span class="o">.</span><span class="n">QUBO_model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">bit_info</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ClusterExpansionExcutor</span><span class="o">.</span><span class="n">make_qubit</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span><span class="n">model</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bit_info</span><span class="p">[</span><span class="s1">&#39;qubits&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">atom</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">bit_info</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">((</span><span class="n">result_dict</span><span class="p">[</span><span class="s2">&quot;best_bits&quot;</span><span class="p">][</span><span class="n">bit_info</span><span class="p">[</span><span class="s1">&#39;qubits&#39;</span><span class="p">]]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">atom</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">bit_info</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">][((</span><span class="mi">1</span><span class="o">-</span><span class="n">result_dict</span><span class="p">[</span><span class="s2">&quot;best_bits&quot;</span><span class="p">][</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)]</span>
	<span class="k">return</span> <span class="n">model</span>

	<span class="c1"># model.set_atomic_numbers(model.get_tags())</span>
	<span class="c1"># cluster_index_dict = cluster2index(config,settings.cluster_mng.prim,cluster_list.clusters,model)</span>
	<span class="c1"># bulk2slabの##を確認, 一旦動いたら。</span>
	<span class="c1"># bulkでもself.tag2grouped_basis作る?</span>
	<span class="c1"># loggerつける?</span>
	<span class="c1"># 最終的に11元素以上に対応するためにはcf_nameをcX__tag_tag_tag_basisbasisからcX__tag_tag_tag__basis_basisにする必要はある。ただ今ではない</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	sublattice_list.sort()</span>
<span class="sd">	print(&quot;474&quot;,name_index_relation)</span>
<span class="sd">	if &quot;_&quot;.join(sublattice_list) not in name_index_relation.keys():</span>
<span class="sd">	&quot;&quot;&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, H.S. &amp; K.S..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>