

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>allfunc &mdash; SurfQit 1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=404a92a0"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../_static/js/language_switcher.js?v=1af0da2e"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SurfQit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/main.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example/main.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../APIreference/main.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SurfQit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">allfunc</li>
      <li class="wy-breadcrumbs-aside">
        
<div class="language-selector">
    <a id="japanese-link" href="#">日本語</a>
    <a id="english-link" href="#">English</a>
</div>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for allfunc</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>

<div class="viewcode-block" id="check_type"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.check_type">[docs]</a><span class="k">def</span> <span class="nf">check_type</span><span class="p">(</span><span class="n">Object</span><span class="p">,</span> <span class="n">Type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The object is None. Parsing may be failed.&quot;</span><span class="p">)</span> <span class="c1">##もう少し考える</span>
    <span class="k">if</span> <span class="n">Type</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">Type</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="n">Type</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Object</span><span class="p">,</span><span class="n">Type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Object</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Type</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span></div>


<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">configparser</span>

<div class="viewcode-block" id="Prepare_Config"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Prepare_Config">[docs]</a><span class="k">class</span> <span class="nc">Prepare_Config</span><span class="p">():</span>
<div class="viewcode-block" id="Prepare_Config.__init__"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Prepare_Config.__init__">[docs]</a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">config_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/config.ini&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1">##自作を使いたい人向け。後で引数の説明を書く。</span></div>

	<span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">section</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">Type</span><span class="p">):</span>
		<span class="n">parameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>
		<span class="n">Object</span> <span class="o">=</span> <span class="n">check_type</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span><span class="n">Type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">Object</span>

<div class="viewcode-block" id="Prepare_Config.read"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Prepare_Config.read">[docs]</a>	<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">contents</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">config_dict</span><span class="p">[</span><span class="n">section_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">section_content</span><span class="p">)</span>
		<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span></div>

<div class="viewcode-block" id="Prepare_Config.write"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Prepare_Config.write">[docs]</a>	<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">section</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div></div>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">ase.io</span>

<div class="viewcode-block" id="storage_path_initialize"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.storage_path_initialize">[docs]</a><span class="k">def</span> <span class="nf">storage_path_initialize</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		config: Prepare_Configクラスのもの。</span>
<span class="sd">	description:</span>
<span class="sd">		storage_pathを設定し、hostの構造と使用するconfigを保存する(ある意味、その時々の状況のセーブになっている)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">storage_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">host_path</span>    <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;host_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">model_type</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">storage_path</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="s2">&quot;&#39;work&#39; directory exist. Please rename, delete or move it.&quot;</span><span class="p">)</span>
	<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">host_path</span><span class="p">)</span>
	<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="n">host</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;config.ini&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
		<span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>


<span class="kn">import</span> <span class="nn">spglib</span>
<span class="kn">import</span> <span class="nn">ase.io</span>
<span class="kn">import</span> <span class="nn">json</span>

<div class="viewcode-block" id="output_symmetry"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.output_symmetry">[docs]</a><span class="k">def</span> <span class="nf">output_symmetry</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">storage_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		config: Prepare_Configクラスのもの。</span>
<span class="sd">		storage_path: configで自動設定されるが、別用途で使いたいときのため</span>
<span class="sd">		host: 同上, 設定の時はase.Atoms class</span>
<span class="sd">	output:</span>
<span class="sd">		rotations: 回転対称操作</span>
<span class="sd">		translations: 並進対称操作</span>
<span class="sd">	description:</span>
<span class="sd">		host.cifの対称性を確認するとともに対称操作を返す</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">storage_path</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
		<span class="n">storage_path</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">symmetry_tolerance</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;symmetry_tolerance&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
	<span class="n">space_group</span>        <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;space_group&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span>
	<span class="n">model_type</span>         <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">host</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
		<span class="n">host</span>      <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
	<span class="n">model_type</span>           <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">model_type</span> <span class="o">!=</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="c1"># slabではz方向の対称性を失わせる</span>
		<span class="n">max_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()[:,</span><span class="mi">2</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">host</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_z</span><span class="p">:</span>
				<span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">symmetry_tolerance</span><span class="o">*</span><span class="mi">2</span>
	<span class="n">symmetry</span>      <span class="o">=</span> <span class="n">spglib</span><span class="o">.</span><span class="n">get_symmetry_dataset</span><span class="p">((</span><span class="n">host</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(),</span><span class="n">host</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(),</span><span class="n">host</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">()),</span><span class="n">symprec</span><span class="o">=</span><span class="n">symmetry_tolerance</span><span class="p">,</span><span class="n">hall_number</span><span class="o">=</span><span class="n">space_group</span><span class="p">)</span>
	<span class="n">symmetry_data</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;international&#39;</span><span class="p">])</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group hall&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;hall&#39;</span><span class="p">])</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;equivalent atom&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;equivalent_atoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">host</span><span class="p">)))</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;rotation_operation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;translate_operation&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;translations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;equivalent_arrange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symmetry_equivalent_arrange</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;symmetry.json&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">symmetry_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">],</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;translations&#39;</span><span class="p">]</span></div>

<span class="kn">import</span> <span class="nn">ase.io</span>

<div class="viewcode-block" id="convert_nanosheet_into_slab"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.convert_nanosheet_into_slab">[docs]</a><span class="k">def</span> <span class="nf">convert_nanosheet_into_slab</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">##この関数をoutput_symmetryに組み込むか、組み込むとconfigで設定するかを考える必要がある。が、後で何とでもなるのでとりあえず外に置いておく。また、aseで作った奴でひっくり返すだけで元の位置に重なるものではない限り不要。判定する関数?</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		config: Prepare_Configクラスのもの。</span>
<span class="sd">		host: configで自動設定されるが、別用途で使いたいときのため。設定の時はase.Atoms class</span>
<span class="sd">	output:</span>
<span class="sd">		None</span>
<span class="sd">	description:</span>
<span class="sd">		ナノシートモデル(上下とも緩和)をスラブモデル(固定層を設定)に変換。output_symmetryに入れる前に行うことでスラブモデルの場合はz方向に少し原子を動かすことでz方向の対称性をなくす。</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">storage_path</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">symmetry_tolerance</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;symmetry_tolerance&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">host</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
		<span class="n">host</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
	<span class="n">max_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()[:,</span><span class="mi">2</span><span class="p">])</span>
	<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">host</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_z</span><span class="p">:</span>
			<span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">symmetry_tolerance</span><span class="o">*</span><span class="mi">10</span>
	<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="n">host</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span></div>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cython</span> 

<div class="viewcode-block" id="symmetry_equivalent_arrange"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.symmetry_equivalent_arrange">[docs]</a><span class="k">def</span> <span class="nf">symmetry_equivalent_arrange</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">symmetry</span><span class="p">):</span> <span class="c1"># memory-friendly imprementation</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		host: 対称性を明らかにしたい構造。</span>
<span class="sd">		symmetry: spglib.get_symmetry_datasetの結果か、dict:{&quot;rotations&quot;: output_symmetry(config)[0],&quot;translations&quot;: output_symmetry(config)[1]}でOK</span>
<span class="sd">	output:</span>
<span class="sd">		symmtetry_equivalent_arrange_index: 並進回転対象運動後の原子位置の移動先</span>
<span class="sd">	description:</span>
<span class="sd">		host.cifの対称性を確認するとともに対称操作を返す</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">rotate</span>         <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">]</span>    <span class="c1"># [operation,xyz,xyz]</span>
	<span class="n">translate</span>      <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;translations&#39;</span><span class="p">]</span> <span class="c1"># [operation,abc]</span>
	<span class="n">fractional</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># 丸め誤差で-1e-16とかが出てくると%1.0が1.0になってしまう</span>
	<span class="n">operated</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotate</span><span class="p">,</span><span class="n">fractional</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">translate</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># [atom,operation,xyz]</span>
	<span class="n">operated</span>       <span class="o">=</span> <span class="n">operated</span><span class="o">%</span><span class="mf">1.0</span>
	<span class="n">operated_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">C_position_to_index</span><span class="p">(</span><span class="n">fractional</span><span class="p">,</span><span class="n">operated</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#[atom, operation]</span>
	<span class="k">return</span> <span class="n">operated_index</span><span class="o">.</span><span class="n">T</span> <span class="c1"># [operation, (index of ) atoms] </span></div>

<span class="kn">import</span> <span class="nn">ase.io</span>
<span class="kn">import</span> <span class="nn">os</span>

<div class="viewcode-block" id="visualize_symmetry_operation"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.visualize_symmetry_operation">[docs]</a><span class="k">def</span> <span class="nf">visualize_symmetry_operation</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	input:</span>
<span class="sd">		config: Prepare_Configクラスのもの。</span>
<span class="sd">	output:</span>
<span class="sd">		None</span>
<span class="sd">	description:</span>
<span class="sd">		visualizeフォルダにsymmetry_operationフォルダを作り、対称操作の結果を記したcifファイルを保存する</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">storage_path</span>          <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
	<span class="n">roration</span><span class="p">,</span> <span class="n">translation</span> <span class="o">=</span> <span class="n">output_symmetry</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
	<span class="n">symmtetry_equivalent_arrange_index</span> <span class="o">=</span> <span class="n">symmetry_equivalent_arrange</span><span class="p">(</span><span class="n">host</span><span class="p">,{</span><span class="s2">&quot;rotations&quot;</span><span class="p">:</span> <span class="n">roration</span><span class="p">,</span><span class="s2">&quot;translations&quot;</span><span class="p">:</span> <span class="n">translation</span><span class="p">})</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;visualize/&quot;</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;visualize/&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;visualize/symmetry_operation/&quot;</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">storage_path</span><span class="si">}</span><span class="s2">/visualize/symmetry_operation/ directory exist. Please rename, delete or move it.&quot;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span> 
		<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;visualize/symmetry_operation/&quot;</span><span class="p">)</span>
	<span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
		<span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">visual_preference_surface</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">host</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">surface</span><span class="p">][:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
	<span class="n">substitute_indice</span> <span class="o">=</span> <span class="p">[</span><span class="n">surface</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">visual_preference_surface</span><span class="o">==</span><span class="n">preference</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">preference</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span>	
	<span class="k">for</span> <span class="n">model_index</span><span class="p">,</span><span class="n">operated_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symmtetry_equivalent_arrange_index</span><span class="p">):</span> <span class="c1">##ここ変えたので、QUBO作成で困るかも。だめなら戻す</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">atomic_number_difference</span><span class="p">,</span> <span class="n">substitute_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">operated_index</span><span class="p">[</span><span class="n">substitute_indice</span><span class="p">]):</span>
			<span class="n">model</span><span class="p">[</span><span class="n">substitute_index</span><span class="p">]</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">numbers</span><span class="p">[</span><span class="n">substitute_index</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">atomic_number_difference</span>
		<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">storage_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;visualize/symmetry_operation/symmetry_model</span><span class="si">{</span><span class="n">model_index</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">)</span></div>

<span class="kn">from</span> <span class="nn">ase.build</span> <span class="kn">import</span> <span class="n">surface</span><span class="p">,</span> <span class="n">add_vacuum</span>

<div class="viewcode-block" id="bulk2slab"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.bulk2slab">[docs]</a><span class="k">def</span> <span class="nf">bulk2slab</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">,</span><span class="n">miller</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="p">):</span>
	<span class="c1">##primitive atoms object of surface must be primitive along x-y but target structure along z</span>
	<span class="c1">##surfaceはprimitiveに対して働かないらしいが、ちゃんと動いているので今は放置。必要があれば(ある意味セルを再構築しているだけなので)自分で書くのもあり</span>
	<span class="n">prim</span> <span class="o">=</span> <span class="n">surface</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">,</span> <span class="n">miller</span><span class="p">,</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">prim</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">)))</span> <span class="c1">## 入力が2*2とかの時にrepeatでいいのか不明, そもそも複数サイトで働かない?⇒basis groupを考える必要。, 酸化物表面も重要。</span>
	<span class="n">size_x</span><span class="p">,</span><span class="n">size_y</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">size</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_x</span><span class="p">,</span><span class="n">size_y</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">add_vacuum</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">prim</span><span class="p">,</span><span class="n">size</span></div>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<div class="viewcode-block" id="adjust_concentration_each_layer"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.adjust_concentration_each_layer">[docs]</a><span class="k">def</span> <span class="nf">adjust_concentration_each_layer</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">ranges</span><span class="p">):</span>
	<span class="c1">##primのtagは層数に対応している。0の中のindexを拡張していくイメージで		</span>
	<span class="n">layer_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">prim</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()))</span>
	<span class="n">unit_atom_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span><span class="o">//</span><span class="n">layer_num</span>
	<span class="n">basis_elements_each_layer</span><span class="p">,</span><span class="n">grouped_basis_each_layer</span><span class="p">,</span><span class="n">ranges_each_layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prim</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),[],[]</span>
	<span class="k">for</span> <span class="n">elements</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">concentrain_range</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">ranges</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">each_index</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
			<span class="n">basis_elements_each_layer</span><span class="p">[</span><span class="n">each_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">elements</span>
		<span class="n">grouped_basis_each_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
		<span class="n">ranges_each_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concentrain_range</span><span class="p">)</span>
		<span class="n">ref_index</span> <span class="o">=</span> <span class="n">index</span>
		<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_num</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
			<span class="n">objective_index</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">ind</span><span class="o">+</span><span class="n">unit_atom_num</span><span class="o">*</span><span class="n">layer</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">index</span><span class="p">])</span>
			<span class="k">for</span> <span class="n">each_index</span> <span class="ow">in</span> <span class="n">objective_index</span><span class="p">:</span>
				<span class="n">basis_elements_each_layer</span><span class="p">[</span><span class="n">each_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">elements</span>
			<span class="n">grouped_basis_each_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objective_index</span><span class="p">)</span>
			<span class="n">ranges_each_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concentrain_range</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">basis_elements_each_layer</span><span class="p">,</span><span class="n">grouped_basis_each_layer</span><span class="p">,</span><span class="n">ranges_each_layer</span></div>

<span class="kn">from</span> <span class="nn">clease.settings.atoms_manager</span> <span class="kn">import</span> <span class="n">AtomsManager</span>

<div class="viewcode-block" id="SurfaceAtomsManager"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.SurfaceAtomsManager">[docs]</a><span class="k">class</span> <span class="nc">SurfaceAtomsManager</span><span class="p">(</span><span class="n">AtomsManager</span><span class="p">):</span>
<div class="viewcode-block" id="SurfaceAtomsManager.__init__"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.SurfaceAtomsManager.__init__">[docs]</a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">atoms</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span></div>

<div class="viewcode-block" id="SurfaceAtomsManager.index_by_basis"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.SurfaceAtomsManager.index_by_basis">[docs]</a>	<span class="k">def</span> <span class="nf">index_by_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">):</span>
		<span class="n">ind_by_symbol</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">grouped_basis</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">ind_by_symbol</span></div>

<div class="viewcode-block" id="SurfaceAtomsManager.basisindex_by_tag"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.SurfaceAtomsManager.basisindex_by_tag">[docs]</a>	<span class="k">def</span> <span class="nf">basisindex_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag2grouped_basis</span><span class="p">):</span>
		<span class="n">ind_by_tag</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">tag_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tag2grouped_basis</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
		<span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
			<span class="n">ind_by_tag</span><span class="p">[</span><span class="n">tag2grouped_basis</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ind_by_tag</span></div></div>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">clease.settings</span> <span class="kn">import</span> <span class="n">ClusterExpansionSettings</span>
<span class="kn">from</span> <span class="nn">clease.settings.settings</span> <span class="kn">import</span> <span class="n">_get_concentration</span>
<span class="kn">from</span> <span class="nn">clease.settings.template_atoms</span> <span class="kn">import</span> <span class="n">TemplateAtoms</span>
<span class="kn">from</span> <span class="nn">clease.settings.template_filters</span> <span class="kn">import</span> <span class="n">ValidConcentrationFilter</span>
<span class="kn">from</span> <span class="nn">clease.settings.atoms_manager</span> <span class="kn">import</span> <span class="n">AtomsManager</span>
<span class="c1">#import SurfaceAtomsManager</span>
<span class="c1">#import ClusterManager_each_sublattice</span>

<div class="viewcode-block" id="ClusterExpansionSettings_nowarning"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionSettings_nowarning">[docs]</a><span class="k">class</span> <span class="nc">ClusterExpansionSettings_nowarning</span><span class="p">(</span><span class="n">ClusterExpansionSettings</span><span class="p">):</span>
<div class="viewcode-block" id="ClusterExpansionSettings_nowarning.__init__"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionSettings_nowarning.__init__">[docs]</a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prim</span><span class="p">,</span><span class="n">concentration</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">supercell_factor</span> <span class="o">=</span> <span class="mi">27</span><span class="p">,</span><span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;clease.db&quot;</span><span class="p">,</span><span class="n">max_cluster_dia</span><span class="o">=</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span><span class="n">include_background_atoms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">basis_func_type</span><span class="o">=</span><span class="s2">&quot;polynomial&quot;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_include_background_atoms</span> <span class="o">=</span> <span class="n">include_background_atoms</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_cluster_mng</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_trans_matrix</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_cluster_list</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_basis_func_type</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_prim_cell</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="n">_get_concentration</span><span class="p">(</span><span class="n">concentration</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_check_first_elements</span><span class="p">()</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">db_name</span> <span class="o">=</span> <span class="n">db_name</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_prim_cell</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span>

		<span class="n">prim_mng</span> <span class="o">=</span> <span class="n">SurfaceAtomsManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">)</span>
		<span class="n">grouped_basis</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">concentration</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tag2grouped_basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">,</span><span class="n">concentration</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span>
		<span class="n">prim_ind_by_basis</span> <span class="o">=</span> <span class="n">prim_mng</span><span class="o">.</span><span class="n">index_by_basis</span><span class="p">(</span><span class="n">grouped_basis</span><span class="p">)</span> <span class="c1">##modified</span>
		<span class="n">conc_filter</span> <span class="o">=</span> <span class="n">ValidConcentrationFilter</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span> <span class="n">prim_ind_by_basis</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">atoms_mng</span> <span class="o">=</span> <span class="n">SurfaceAtomsManager</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

		<span class="c1"># Construct the template atoms, this is a protected property</span>
		<span class="c1"># Access and changes to size and/or supercell factor are redirected to</span>
		<span class="c1"># this instance.</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_template_atoms</span> <span class="o">=</span> <span class="n">TemplateAtoms</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">,</span>
			<span class="n">supercell_factor</span><span class="o">=</span><span class="n">supercell_factor</span><span class="p">,</span>
			<span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
			<span class="n">skew_threshold</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
			<span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="n">conc_filter</span><span class="p">],</span>
		<span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">set_active_template</span><span class="p">()</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_dia</span> <span class="o">=</span> <span class="n">max_cluster_dia</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">basis_func_type</span> <span class="o">=</span> <span class="n">basis_func_type</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_basis</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;list of elements is needed for each basis&quot;</span><span class="p">)</span>

		<span class="c1"># For storing the settings from the CLEASE factories.</span>
		<span class="c1"># Just for bookkeeping</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span></div>

	<span class="k">def</span> <span class="nf">_check_first_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

<div class="viewcode-block" id="ClusterExpansionSettings_nowarning.tag2grouped_basis"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionSettings_nowarning.tag2grouped_basis">[docs]</a>	<span class="k">def</span> <span class="nf">tag2grouped_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prim_cell</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">):</span> <span class="c1">##ここでindexごちゃりそうで怖い</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tag2grouped_basis</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">group</span><span class="p">,</span><span class="n">content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grouped_basis</span><span class="p">):</span> <span class="c1">##ここのタグづけがcf_calculator_each_sublatticeの対称性管理のためのモデル構造に使われるので多元系でちゃんと確認。</span>
			<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">tag2grouped_basis</span><span class="p">[</span><span class="n">prim_cell</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span></div>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">index_by_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_mng</span><span class="o">.</span><span class="n">basisindex_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag2grouped_basis</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">all_cf_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">num_bf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_functions</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_list</span><span class="o">.</span><span class="n">get_all_cf_names</span><span class="p">(</span><span class="n">num_bf</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">cluster_mng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_mng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_background_atoms</span><span class="p">:</span>
				<span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;background_syms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bg_syms</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_cluster_mng</span> <span class="o">=</span> <span class="n">ClusterManager_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_mng</span></div>

<span class="c1">#import output_symmetry</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<div class="viewcode-block" id="cluster2index"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.cluster2index">[docs]</a><span class="k">def</span> <span class="nf">cluster2index</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">prim</span><span class="p">,</span><span class="n">clusters</span><span class="p">,</span><span class="n">target_structure</span><span class="p">):</span> 
	<span class="n">rotations</span><span class="p">,</span><span class="n">translations</span> <span class="o">=</span> <span class="n">output_symmetry</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">target_structure</span><span class="p">)</span>
	<span class="n">symmtetry_equivalent_index</span> <span class="o">=</span> <span class="n">symmetry_equivalent_arrange</span><span class="p">(</span><span class="n">target_structure</span><span class="p">,{</span><span class="s2">&quot;rotations&quot;</span><span class="p">:</span><span class="n">rotations</span><span class="p">,</span><span class="s2">&quot;translations&quot;</span><span class="p">:</span><span class="n">translations</span><span class="p">})</span><span class="o">.</span><span class="n">T</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">target_structure</span><span class="o">.</span><span class="n">cell</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prim</span><span class="o">.</span><span class="n">cell</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
	<span class="n">cluster_index_dict</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;c0&quot;</span><span class="p">:</span>
			<span class="n">cluster_index_dict</span><span class="p">[</span><span class="s2">&quot;c0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="k">elif</span> <span class="s2">&quot;c1&quot;</span> <span class="ow">in</span> <span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
			<span class="n">index_list</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">cluster</span><span class="o">.</span><span class="n">figures</span><span class="p">:</span>
				<span class="n">figure_positions</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">for</span> <span class="n">fourvector</span> <span class="ow">in</span> <span class="n">figure</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
					<span class="n">figure_positions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fourvector</span><span class="o">.</span><span class="n">to_scaled</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
				<span class="n">figure_positions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">figure_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">figure_positions</span><span class="p">)</span>
				<span class="n">figure_positions</span> <span class="o">=</span> <span class="p">(</span><span class="n">figure_positions</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">figure_positions</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">//</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				<span class="n">figure_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">figure_positions</span><span class="o">==</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">figure_positions</span><span class="p">)</span>
				<span class="n">figure_index</span> <span class="o">=</span> <span class="n">C_position_to_index</span><span class="p">(</span><span class="n">figure_positions</span><span class="p">,</span><span class="n">target_structure</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:])</span>
				<span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure_index</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
			<span class="n">cluster_index_dict</span><span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">symmtetry_equivalent_index</span><span class="p">[</span><span class="n">figure_index</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">cluster_index_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
			<span class="n">cluster_index</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">cluster_index_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">all_index_</span>     <span class="o">=</span> <span class="n">symmtetry_equivalent_index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cluster_index</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">all_index</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">all_index_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">cluster_index_dict</span><span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_index</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">cluster_index_dict</span></div>

<div class="viewcode-block" id="cf_calculator_each_sublattice"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.cf_calculator_each_sublattice">[docs]</a><span class="k">def</span> <span class="nf">cf_calculator_each_sublattice</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">atoms</span><span class="p">,</span><span class="n">settings</span><span class="p">,</span><span class="n">cf_dict</span><span class="p">,</span><span class="n">cluster_list</span><span class="p">):</span>
	<span class="n">model</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="n">model</span><span class="o">.</span><span class="n">set_atomic_numbers</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_tags</span><span class="p">())</span>
	<span class="n">cluster_index_dict</span> <span class="o">=</span> <span class="n">cluster2index</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_mng</span><span class="o">.</span><span class="n">prim</span><span class="p">,</span><span class="n">cluster_list</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span><span class="n">model</span><span class="p">)</span> 
	<span class="n">basis</span>              <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">basis_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">basis_functions</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
		<span class="k">raise</span> <span class="n">NotImprementedError</span><span class="p">(</span><span class="s2">&quot;This version of SurfQit cannot handle surfaces with multiple-site.&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">cluster_name</span> <span class="ow">in</span> <span class="n">cf_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">cluster_name</span> <span class="o">==</span> <span class="s2">&quot;c0&quot;</span><span class="p">:</span> <span class="c1"># もとから0が入っている</span>
			<span class="k">continue</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">cluster_list_name</span> <span class="ow">in</span> <span class="n">cluster_list</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">cluster_list_name</span> <span class="ow">in</span> <span class="n">cluster_name</span><span class="p">:</span>
					<span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span> <span class="o">+</span> <span class="n">cluster_index_dict</span><span class="p">[</span><span class="n">cluster_list_name</span><span class="p">]</span>
			<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">cf</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
				<span class="n">each_cf</span> <span class="o">=</span> <span class="mf">1.0</span>
				<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
					<span class="n">each_cf</span> <span class="o">*=</span> <span class="n">basis</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
				<span class="n">cf</span> <span class="o">+=</span> <span class="n">each_cf</span>
			<span class="n">cf_dict</span><span class="p">[</span><span class="n">cluster_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">cf_dict</span></div>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ase.io</span>
<span class="c1"># import cf_calculator_each_sublattice</span>

<div class="viewcode-block" id="validate_calculatedCF"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.validate_calculatedCF">[docs]</a><span class="k">def</span> <span class="nf">validate_calculatedCF</span><span class="p">(</span><span class="n">cluster_expansion_excutor</span><span class="p">):</span> 
	<span class="n">ce</span>                 <span class="o">=</span> <span class="n">cluster_expansion_excutor</span>
	<span class="n">reference_matrix</span>   <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">cf_matrix</span>
	<span class="n">CF_matirx</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">reference_matrix</span><span class="p">)</span>
	<span class="n">all_path</span>           <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="s2">&quot;id*.cif&quot;</span><span class="p">)</span>
	<span class="n">id_list</span>            <span class="o">=</span> <span class="p">[]</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">basis_functions</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">NotImprementedError</span><span class="p">(</span><span class="s2">&quot;This version of SurfQit cannot handle surfaces with multiple-site.&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">all_path</span><span class="p">:</span>
		<span class="k">if</span> <span class="s2">&quot;afteropt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
			<span class="n">id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]))</span>
	<span class="n">id_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">model_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">id_list</span><span class="p">):</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;id</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">)</span>
		<span class="n">cf_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ce</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">cf_names</span><span class="p">}</span>
		<span class="n">cf_dict</span> <span class="o">=</span> <span class="n">cf_calculator_each_sublattice</span><span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">ce</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span><span class="n">cf_dict</span><span class="p">,</span><span class="n">ce</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">)</span>
		<span class="n">CF_matirx</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cf_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
	<span class="k">return</span> <span class="n">reference_matrix</span><span class="p">,</span><span class="n">CF_matirx</span></div>

<span class="kn">from</span> <span class="nn">clease.cluster</span> <span class="kn">import</span> <span class="n">ClusterManager</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">clease.cluster</span> <span class="kn">import</span> <span class="n">Cluster</span>
<span class="kn">from</span> <span class="nn">clease.datastructures</span> <span class="kn">import</span> <span class="n">Figure</span><span class="p">,</span> <span class="n">FourVector</span>
<span class="kn">from</span> <span class="nn">clease.cluster.cluster_fingerprint</span> <span class="kn">import</span> <span class="n">ClusterFingerprint</span>

<div class="viewcode-block" id="ClusterManager_each_sublattice"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterManager_each_sublattice">[docs]</a><span class="k">class</span> <span class="nc">ClusterManager_each_sublattice</span><span class="p">(</span><span class="n">ClusterManager</span><span class="p">):</span>
<div class="viewcode-block" id="ClusterManager_each_sublattice.__init__"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterManager_each_sublattice.__init__">[docs]</a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim_cell</span><span class="p">,</span> <span class="n">background_syms</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">prim_cell</span><span class="p">,</span> <span class="n">background_syms</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterManager_each_sublattice.build"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterManager_each_sublattice.build">[docs]</a>	<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_cluster_dia</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_build</span><span class="p">(</span><span class="n">max_cluster_dia</span><span class="p">):</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_prepare_new_build</span><span class="p">(</span><span class="n">max_cluster_dia</span><span class="p">)</span>

		<span class="n">num_lattices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim</span><span class="p">))</span>
		<span class="n">all_fps</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">all_figures</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">lattices</span> <span class="o">=</span> <span class="p">[]</span>

		<span class="k">for</span> <span class="n">ref_lattice</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span><span class="p">,</span> <span class="n">diameter</span><span class="p">)</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">num_lattices</span><span class="p">,</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">max_cluster_dia</span><span class="p">)):</span>
			<span class="n">cluster_size</span> <span class="o">=</span> <span class="n">indx</span> <span class="o">+</span> <span class="mi">2</span>
			<span class="n">figures</span><span class="p">,</span> <span class="n">fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">cluster_size</span><span class="p">,</span> <span class="n">diameter</span><span class="p">,</span> <span class="n">ref_lattice</span><span class="p">)</span>

			<span class="n">all_fps</span> <span class="o">+=</span> <span class="n">fps</span>
			<span class="n">all_figures</span> <span class="o">+=</span> <span class="n">figures</span>
			<span class="n">lattices</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ref_lattice</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span>

		<span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_names</span><span class="p">(</span><span class="n">all_fps</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">figures</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ref_lattice</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_figures</span><span class="p">,</span> <span class="n">all_fps</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">lattices</span><span class="p">):</span>
			<span class="n">cluster_size</span> <span class="o">=</span> <span class="n">figures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
			<span class="n">diameter</span> <span class="o">=</span> <span class="n">figures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_diameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim</span><span class="p">)</span>
			<span class="n">eq_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">equivalent_sites</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			
			<span class="n">name_index_relation</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">figures</span><span class="p">:</span> <span class="c1">##sublattice毎にfigureの名前を分ける。forが多いので重たくなりそう。あまりに遅いなら考える</span>
				<span class="c1">##sublatticeとは結局sizeで広げる前のモデルのindexなので、モデル中に等価なサイトが入っていないと仮定している。</span>
				<span class="c1">##完全等価なら従来のClusterManagerを使えばよい。ところどころ等価ならあきらめて分けるか、tagで分けるか。(self.generator.generateをいじればいいが未実装)</span>
				<span class="n">sublattice_list</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">for</span> <span class="n">fourvector</span> <span class="ow">in</span> <span class="n">figure</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
					<span class="n">sublattice_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fourvector</span><span class="o">.</span><span class="n">sublattice</span><span class="p">))</span>
				<span class="n">sublattice_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
				<span class="k">if</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sublattice_list</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name_index_relation</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">name_index_relation</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sublattice_list</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">figure</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">name_index_relation</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sublattice_list</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
			
			<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">name_index_relation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">(</span>
					<span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;__&quot;</span><span class="o">+</span><span class="n">key</span><span class="p">,</span>
					<span class="n">size</span><span class="o">=</span><span class="n">cluster_size</span><span class="p">,</span>
					<span class="n">diameter</span><span class="o">=</span><span class="n">diameter</span><span class="p">,</span>
					<span class="n">fingerprint</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span>
					<span class="n">figures</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
					<span class="n">equiv_sites</span><span class="o">=</span><span class="n">eq_sites</span><span class="p">,</span>
					<span class="n">group</span><span class="o">=</span><span class="n">ref_lattice</span><span class="p">,</span> <span class="c1"># ここのgroupはprim内のatom毎に割り振られている(等価かどうかは関係がない)</span>
				<span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
				<span class="n">Cluster</span><span class="p">(</span>
					<span class="n">name</span><span class="o">=</span><span class="s2">&quot;c1&quot;</span><span class="o">+</span><span class="s2">&quot;__&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">),</span>
					<span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">diameter</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
					<span class="n">fingerprint</span><span class="o">=</span><span class="n">ClusterFingerprint</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span>
					<span class="n">figures</span><span class="o">=</span><span class="p">[</span><span class="n">Figure</span><span class="p">([</span><span class="n">FourVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">)])],</span>
					<span class="n">equiv_sites</span><span class="o">=</span><span class="p">[],</span>
					<span class="n">group</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="c1"># groupはprimのindexについて振られている。等価なサイトを考えるためにnameはtagで判別した。Figureは全てのサイトを基底関数に含めるためにむしろtagではなくindexでみる必要がある</span>
				<span class="p">)</span>
			<span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="n">Cluster</span><span class="p">(</span>
				<span class="n">name</span><span class="o">=</span><span class="s2">&quot;c0&quot;</span><span class="p">,</span>
				<span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
				<span class="n">diameter</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
				<span class="n">fingerprint</span><span class="o">=</span><span class="n">ClusterFingerprint</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span>
				<span class="n">figures</span><span class="o">=</span><span class="p">[],</span>
				<span class="n">equiv_sites</span><span class="o">=</span><span class="p">[],</span>
				<span class="n">group</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span></div></div>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span>  <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">clease.settings.concentration</span> <span class="kn">import</span> <span class="n">Concentration</span>
<span class="c1">#import bulk2slab</span>
<span class="c1">#import adjust_concentration_each_layer</span>
<span class="c1">#import ClusterExpansionSettings_nowarning</span>

<div class="viewcode-block" id="CESlab_nowarning"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CESlab_nowarning">[docs]</a><span class="k">def</span> <span class="nf">CESlab_nowarning</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">,</span><span class="n">miller</span><span class="p">,</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">ranges</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="p">,</span><span class="n">model_type</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	:param conventional_cell:</span>
<span class="sd">		Bulk lattice structure. Note that the unit-cell</span>
<span class="sd">		must be the conventional cell - not the primitive cell. One can also</span>
<span class="sd">		give the chemical symbol as a string, in which case the correct bulk</span>
<span class="sd">		lattice will be generated automatically.</span>

<span class="sd">	:param miller:</span>
<span class="sd">		Surface normal in Miller indices (h,k,l).</span>

<span class="sd">	:param concentration:</span>
<span class="sd">		Class for restricting the concentrations</span>

<span class="sd">	:param size:</span>
<span class="sd">		Size of the simulations cell. The third number represents the number of</span>
<span class="sd">		layers. The two first are repetitions of the in-plane unit vectors</span>

<span class="sd">	For more kwargs, see docstring of :class:`clease.settings.ClusterExpansionSettings`.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;slab_from_bulk&quot;</span><span class="p">:</span>
		<span class="n">prim</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="n">bulk2slab</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">,</span><span class="n">miller</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">grouped_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
			<span class="n">grouped_basis</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conventional_cell</span><span class="p">)))]</span>
		<span class="n">basis_elements_each_layer</span><span class="p">,</span><span class="n">grouped_basis_each_layer</span><span class="p">,</span><span class="n">ranges_each_layer</span> <span class="o">=</span> <span class="n">adjust_concentration_each_layer</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">ranges</span><span class="p">)</span>
		<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="n">basis_elements_each_layer</span><span class="p">,</span><span class="n">grouped_basis</span><span class="o">=</span><span class="n">grouped_basis_each_layer</span><span class="p">)</span>
		<span class="n">concentration</span><span class="o">.</span><span class="n">set_conc_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="n">ranges_each_layer</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">prim</span> <span class="o">=</span> <span class="n">conventional_cell</span> 
		<span class="k">if</span> <span class="n">grouped_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
			<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="n">basis_elements</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="o">=</span><span class="n">grouped_basis</span><span class="p">)</span>
		<span class="n">concentration</span><span class="o">.</span><span class="n">set_conc_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">)</span>

	<span class="c1"># Slab should always have one cell vector along the z-axis</span>
	<span class="n">settings</span> <span class="o">=</span> <span class="n">ClusterExpansionSettings_nowarning</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span> <span class="n">concentration</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

	<span class="n">dict_rep</span> <span class="o">=</span> <span class="n">conventional_cell</span><span class="o">.</span><span class="n">todict</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_rep</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
			<span class="n">dict_rep</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

	<span class="n">settings</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
		<span class="p">{</span><span class="s2">&quot;factory&quot;</span><span class="p">:</span> <span class="s2">&quot;CESlab_nowarning&quot;</span><span class="p">,</span><span class="s2">&quot;miller&quot;</span><span class="p">:</span> <span class="n">miller</span><span class="p">,</span><span class="s2">&quot;conventional_cell&quot;</span><span class="p">:</span> <span class="n">dict_rep</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">}</span>
	<span class="p">)</span>
	<span class="k">return</span> <span class="n">settings</span></div>

<span class="kn">from</span> <span class="nn">ase.db</span> <span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span> <span class="nn">ase.calculators.emt</span> <span class="kn">import</span> <span class="n">EMT</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ase.io</span>
<span class="kn">from</span> <span class="nn">ase.optimize</span> <span class="kn">import</span> <span class="n">LBFGSLineSearch</span>
<span class="kn">from</span> <span class="nn">clease.tools</span> <span class="kn">import</span> <span class="n">update_db</span>
<span class="c1">#import CSV_Reader</span>

<div class="viewcode-block" id="Calculator"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator">[docs]</a><span class="k">class</span> <span class="nc">Calculator</span><span class="p">():</span>
<div class="viewcode-block" id="Calculator.__init__"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.__init__">[docs]</a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">db_name</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;train_data/training_data.db&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;train_data/energy_data.csv&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">method</span>       <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;calculate_method&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fmax</span>         <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;fmax&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;EMT&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">EMT</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">CSV_Reader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;csv_reader&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">CSV_Reader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">is not implemented&quot;</span><span class="p">)</span></div>

	<span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">calculate_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">model_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">id</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toatoms</span><span class="p">()</span>
		<span class="n">calculate_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">constraint_dict</span><span class="p">)</span>
		
<div class="viewcode-block" id="Calculator.optimization"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.optimization">[docs]</a>	<span class="k">def</span> <span class="nf">optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">##複雑な計算をやりたいときは外部で計算してcsvを読んだ方が良い</span>
		<span class="n">model</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc</span>
		<span class="k">if</span> <span class="n">constraint_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">model</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">constraint_dict</span><span class="p">[</span><span class="s2">&quot;constraint&quot;</span><span class="p">])</span>
			<span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">constraint_dict</span><span class="p">:</span>
				<span class="n">model</span> <span class="o">=</span> <span class="n">constraint_dict</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">][</span><span class="s2">&quot;function&quot;</span><span class="p">](</span><span class="n">model</span><span class="p">,</span><span class="o">*</span><span class="n">constraint_dict</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">])</span>
		<span class="n">opt</span> <span class="o">=</span> <span class="n">LBFGSLineSearch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
		<span class="n">opt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmax</span><span class="p">)</span>
		<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;train_data/id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="si">}</span><span class="s2">_afteropt.cif&quot;</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">)</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;train_data/id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="si">}</span><span class="s2">_afteropt.cif&quot;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">)</span> <span class="c1">##calculatorによってはopt後と再読み込み後でのget_potential_enegyが違うことがあるので再現性のある値を取りたい。</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">single_point</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculator.single_point"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.single_point">[docs]</a>	<span class="k">def</span> <span class="nf">single_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">model</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc</span>
		<span class="n">energy</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">csv_write</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">energy</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculator.csv_write"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.csv_write">[docs]</a>	<span class="k">def</span> <span class="nf">csv_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">model_id</span><span class="p">,</span><span class="n">energy</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">energy_per_atom</span> <span class="o">=</span> <span class="n">energy</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
			<span class="n">elements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span>
			<span class="n">atom_numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
				<span class="n">atom_numbers</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">elements</span><span class="o">==</span><span class="n">atom</span><span class="o">.</span><span class="n">symbol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">elements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span>
			<span class="n">atom_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)]</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">)</span>
		<span class="n">column</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
		<span class="n">additional_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
		<span class="n">additional_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_id</span>
		<span class="n">additional_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_per_atom</span>
		<span class="n">additional_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
		<span class="k">for</span> <span class="n">element_index</span><span class="p">,</span><span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
			<span class="n">additional_data</span><span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">element</span><span class="p">)]</span> <span class="o">=</span> <span class="n">atom_numbers</span><span class="p">[</span><span class="n">element_index</span><span class="p">]</span> 
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">additional_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">model_id</span><span class="p">])</span>
		<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculator.csv_read"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.csv_read">[docs]</a>	<span class="k">def</span> <span class="nf">csv_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
		<span class="n">model_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">id</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toatoms</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">set_model_id</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
		<span class="n">model</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span>
		<span class="n">model</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
		<span class="n">update_db</span><span class="p">(</span><span class="n">uid_initial</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span> <span class="n">final_struct</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculator.csv_write_formationE"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.Calculator.csv_write_formationE">[docs]</a>	<span class="k">def</span> <span class="nf">csv_write_formationE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">)</span>
		<span class="n">reference_energies</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">energy</span><span class="p">,</span><span class="n">composition</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()):</span>
			<span class="n">nonzero_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">composition</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">reference_energies</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:][</span><span class="n">nonzero_index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">energy</span>
		<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
			<span class="n">formation_energy</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">energy_per_atom</span>
			<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">reference_energies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">formation_energy</span> <span class="o">-=</span> <span class="n">row</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">value</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
			<span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span><span class="s2">&quot;formation_energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formation_energy</span>
		<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div></div>

<span class="kn">from</span> <span class="nn">ase.calculators.calculator</span> <span class="kn">import</span> <span class="n">Calculator</span> <span class="k">as</span> <span class="n">ASE_Calculator</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">all_changes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">,</span> <span class="s1">&#39;numbers&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;pbc&#39;</span><span class="p">,</span>
               <span class="s1">&#39;initial_charges&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_magmoms&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="CSV_Reader"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader">[docs]</a><span class="k">class</span> <span class="nc">CSV_Reader</span><span class="p">(</span><span class="n">ASE_Calculator</span><span class="p">):</span> <span class="c1"># based on EMT</span>
    <span class="n">implemented_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
    <span class="n">nolabel</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">default_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;asap_cutoff&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

<div class="viewcode-block" id="CSV_Reader.__init__"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">storage_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span>     <span class="o">=</span> <span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;train_data/energy_data.csv&quot;</span>
        <span class="n">ASE_Calculator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CSV_Reader.calculate"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span> <span class="n">system_changes</span><span class="o">=</span><span class="n">all_changes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_path</span><span class="p">)</span>
        <span class="n">ASE_Calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">system_changes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="s2">&quot;formation_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="CSV_Reader.get_potential_energy"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader.get_potential_energy">[docs]</a>    <span class="k">def</span> <span class="nf">get_potential_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">atoms</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span></div>

<div class="viewcode-block" id="CSV_Reader.set_model_id"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CSV_Reader.set_model_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_model_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">model_id</span></div></div>

<span class="kn">from</span> <span class="nn">clease.structgen</span> <span class="kn">import</span> <span class="n">NewStructures</span>
<span class="c1"># import CorrFunction_each_sublattice</span>

<div class="viewcode-block" id="NewStructures_each_sublattice"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.NewStructures_each_sublattice">[docs]</a><span class="k">class</span> <span class="nc">NewStructures_each_sublattice</span><span class="p">(</span><span class="n">NewStructures</span><span class="p">):</span>
<div class="viewcode-block" id="NewStructures_each_sublattice.__init__"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.NewStructures_each_sublattice.__init__">[docs]</a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">settings</span><span class="p">,</span><span class="n">generation_number</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">struct_per_gen</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span><span class="n">check_db</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">check_db</span> <span class="o">=</span> <span class="n">check_db</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">corrfunc</span> <span class="o">=</span> <span class="n">CorrFunction_each_sublattice</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">struct_per_gen</span> <span class="o">=</span> <span class="n">struct_per_gen</span>

		<span class="k">if</span> <span class="n">generation_number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_gen_number</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">generation_number</span></div></div>

<span class="kn">from</span> <span class="nn">clease.corr_func</span> <span class="kn">import</span> <span class="n">CorrFunction</span>
<span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">Atoms</span>
<span class="c1"># import cf_calculator_each_sublattice</span>

<div class="viewcode-block" id="CorrFunction_each_sublattice"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CorrFunction_each_sublattice">[docs]</a><span class="k">class</span> <span class="nc">CorrFunction_each_sublattice</span><span class="p">(</span><span class="n">CorrFunction</span><span class="p">):</span>
<div class="viewcode-block" id="CorrFunction_each_sublattice.__init__"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CorrFunction_each_sublattice.__init__">[docs]</a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">settings</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span>   <span class="o">=</span> <span class="n">config</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span></div>

<div class="viewcode-block" id="CorrFunction_each_sublattice.get_cf_by_names"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.CorrFunction_each_sublattice.get_cf_by_names">[docs]</a>	<span class="k">def</span> <span class="nf">get_cf_by_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">cf_names</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">Atoms</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">set_template</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;atoms must be Atoms object&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_confirm_cf_names_exists</span><span class="p">(</span><span class="n">cf_names</span><span class="p">)</span>

		<span class="n">cf</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cf_names</span><span class="p">}</span>
		<span class="n">cf</span> <span class="o">=</span> <span class="n">cf_calculator_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">atoms</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span><span class="n">cf</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cf</span></div></div>

<div class="viewcode-block" id="check_position_overlap"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.check_position_overlap">[docs]</a><span class="k">def</span> <span class="nf">check_position_overlap</span><span class="p">(</span><span class="n">new</span><span class="p">,</span><span class="n">reference</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-1</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">positions</span><span class="o">-</span><span class="n">reference</span><span class="o">.</span><span class="n">positions</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input model is not the same structure of the target model.&quot;</span><span class="p">)</span></div>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">ase.io</span>
<span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">from</span> <span class="nn">ase.db</span> <span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span> <span class="nn">ase.build</span> <span class="kn">import</span> <span class="n">add_vacuum</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">clease.settings.concentration</span> <span class="kn">import</span> <span class="n">Concentration</span>
<span class="kn">from</span> <span class="nn">clease.settings</span> <span class="kn">import</span> <span class="n">CECrystal</span><span class="p">,</span><span class="n">CESlab</span>
<span class="kn">from</span> <span class="nn">clease.basis_function</span> <span class="kn">import</span> <span class="n">BasisFunction</span><span class="p">,</span> <span class="n">BinaryLinear</span><span class="p">,</span> <span class="n">Polynomial</span><span class="p">,</span> <span class="n">Trigonometric</span>
<span class="c1">#from clease.settings.settings_slab import remove_vacuum_layers</span>
<span class="kn">from</span> <span class="nn">clease.structgen</span> <span class="kn">import</span> <span class="n">NewStructures</span>
<span class="kn">from</span> <span class="nn">clease</span> <span class="kn">import</span> <span class="n">Evaluate</span>
<span class="c1">#import CESlab_nowarning</span>
<span class="c1">#import Calculator</span>
<span class="c1">#import NewStructures_each_sublattice</span>

<div class="viewcode-block" id="ClusterExpansionExcutor"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor">[docs]</a><span class="k">class</span> <span class="nc">ClusterExpansionExcutor</span><span class="p">():</span>
<div class="viewcode-block" id="ClusterExpansionExcutor.__init__"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.__init__">[docs]</a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		input:</span>
<span class="sd">			config: Prepare_Configクラスのもの。</span>
<span class="sd">			seed: 構造生成をそろえて比較したいとき用</span>
<span class="sd">		output:</span>
<span class="sd">			None</span>
<span class="sd">		description:</span>
<span class="sd">			CEの準備をします。</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">##こんなにいるか?フォルダ構成は考える, bulkはチェックが必要</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">config</span>               <span class="o">=</span> <span class="n">config</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span>         <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">db_name</span>              <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;preparation&#39;</span><span class="p">,</span><span class="s1">&#39;storage_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;train_data/training_data.db&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">host</span>                 <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s1">&#39;host.cif&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;cif&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="s2">&quot;train_data/&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">model_type</span>           <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">miller_index</span>         <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;miller&#39;</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span>     <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;vacuum&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">concentration</span>        <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;substitute_ratio&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span>        <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;group_index&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span>       <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;basis_function&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;supercell_multiple&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span>     <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;max_cluster_size&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span>       <span class="o">=</span> <span class="p">[]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;parallel_calculation&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span>   <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;calculate_method&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">scoring_scheme</span>       <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;scoring_scheme&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nsplits</span>              <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;split_number&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span>       <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;fitting_scheme&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>                <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">annealing_machine</span>    <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;annealing_machine&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">extend</span>               <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;extend_structure&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">QUBO_filename</span>        <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;calculate&#39;</span><span class="p">,</span><span class="s1">&#39;QUBO_path&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
			<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
		<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		##slabでhostをbulkにして生成するようにするのでhostの対称性が意味をなさない。一方でClustersをちゃんと見るとクラスター毎の対称操作後が書いているかもしれない。確認必須</span>
<span class="sd">		with open(self.storage_path+&#39;symmetry.json&#39;,&#39;r&#39;) as f:</span>
<span class="sd">			symmetry_data = json.load(f)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">ranges</span>         <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">substitution</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">substitution</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
			<span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span><span class="n">substitution</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
					<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span>
				<span class="n">concentration</span><span class="o">.</span><span class="n">set_conc_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">CECrystal</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span><span class="n">spacegroup</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group symbol&#39;</span><span class="p">]),</span>\
											<span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(),</span><span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()[:],</span>\
											<span class="n">basis_func_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="p">,</span><span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span>\
											<span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">,</span><span class="n">max_cluster_dia</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">,</span>\
											<span class="n">crystal_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;onduplicates&quot;</span><span class="p">:</span> <span class="s2">&quot;keep&quot;</span><span class="p">})</span> <span class="c1"># no crystal_kwargs leads to print user warning {symmetry sites in self.host} times. </span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span><span class="o">&lt;</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">):</span>
					<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: vacuum @ config should be larger than maximum max_cluster_size @ config to avoid generating interaction between topmost layer and bottom layer through the vacuum layer.&quot;</span><span class="p">)</span>
					<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vacuum @ config set to maximum max_cluster_size @ config.&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">)</span>
					<span class="c1">##config自体も書き換えたほうがユーザーライク?</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">CESlab_nowarning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">miller_index</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">ranges</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">,</span><span class="n">vacuum_thickness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_thickness</span><span class="p">,</span><span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>\
											<span class="n">basis_func_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="p">,</span><span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span><span class="n">max_cluster_dia</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
					<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">concentration</span> <span class="o">=</span> <span class="n">Concentration</span><span class="p">(</span><span class="n">basis_elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span>
				<span class="n">concentration</span><span class="o">.</span><span class="n">set_conc_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">CECrystal</span><span class="p">(</span><span class="n">concentration</span><span class="p">,</span><span class="n">spacegroup</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">symmetry_data</span><span class="p">[</span><span class="s1">&#39;space group symbol&#39;</span><span class="p">]),</span>\
											<span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(),</span><span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()[:],</span>\
											<span class="n">basis_func_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="p">,</span><span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span>\
											<span class="n">supercell_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">max_cluster_dia</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">,</span>\
											<span class="n">crystal_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;onduplicates&quot;</span><span class="p">:</span> <span class="s2">&quot;keep&quot;</span><span class="p">})</span> <span class="c1"># no crystal_kwargs leads to print user warning {symmetry sites in self.host} times. </span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;do not support </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">)</span><span class="si">}</span><span class="s2">-sized supercell_multiple for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2"> mode&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;do not support </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span><span class="p">)</span><span class="si">}</span><span class="s2">-sized supercell_multiple&quot;</span><span class="p">)</span>
		<span class="n">element_candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,[]))))</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="s2">&quot;energy_per_atom&quot;</span><span class="p">,</span><span class="s2">&quot;formation_energy&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">element_candidates</span><span class="p">)</span>
		<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="s2">&quot;energy_data.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterExpansionExcutor.model_addition_random"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.model_addition_random">[docs]</a>	<span class="k">def</span> <span class="nf">model_addition_random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">generation_number</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">##sublatticeが無ければcfでsublatticeの考慮不要</span>
			<span class="n">training_data_generator</span> <span class="o">=</span> <span class="n">NewStructures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">generation_number</span><span class="o">=</span><span class="n">generation_number</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">training_data_generator</span> <span class="o">=</span> <span class="n">NewStructures_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">generation_number</span><span class="o">=</span><span class="n">generation_number</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span><span class="p">)</span>
		<span class="n">training_data_generator</span><span class="o">.</span><span class="n">generate_initial_pool</span><span class="p">()</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
			<span class="n">atom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toatoms</span><span class="p">()</span>
<span class="w">			</span><span class="sd">&quot;&quot;&quot;##CESlabでやっているのでいらないと思う</span>
<span class="sd">			if self.model_type != &quot;bulk&quot;:</span>
<span class="sd">				add_vacuum(atom,self.vacuum_thickness)</span>
<span class="sd">			&quot;&quot;&quot;</span>
			<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">atom</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterExpansionExcutor.add_user_structure"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.add_user_structure">[docs]</a>	<span class="k">def</span> <span class="nf">add_user_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Atoms</span><span class="p">):</span>
			<span class="n">model</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">template_atoms</span><span class="o">.</span><span class="n">weighted_random_template</span><span class="p">()</span>
		<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sorted_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">indices</span><span class="p">]</span>
		<span class="n">check_position_overlap</span><span class="p">(</span><span class="n">sorted_model</span><span class="p">,</span><span class="n">template</span><span class="p">)</span>
		<span class="n">sorted_model</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">positions</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">grouped_basis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">##sublatticeが無ければcfでsublatticeの考慮不要</span>
			<span class="n">data_inserter</span> <span class="o">=</span> <span class="n">NewStructures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">data_inserter</span> <span class="o">=</span> <span class="n">NewStructures_each_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">struct_per_gen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_calculation</span><span class="p">)</span>
		<span class="n">data_inserter</span><span class="o">.</span><span class="n">insert_structure</span><span class="p">(</span><span class="n">sorted_model</span><span class="p">)</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
			<span class="n">atom</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toatoms</span><span class="p">()</span>
			<span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CE_traindata_path</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;id</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">.cif&quot;</span><span class="p">,</span><span class="n">atom</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;cif&quot;</span><span class="p">)</span></div>
			
<div class="viewcode-block" id="ClusterExpansionExcutor.unconverged_calculate"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.unconverged_calculate">[docs]</a>	<span class="k">def</span> <span class="nf">unconverged_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;csv_read&quot;</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">constraint_dict</span><span class="p">)</span> <span class="c1"># 計算を行う</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update_formation_energy</span><span class="p">()</span></div>

<div class="viewcode-block" id="ClusterExpansionExcutor.update_formation_energy"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.update_formation_energy">[docs]</a>	<span class="k">def</span> <span class="nf">update_formation_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">csv_write_formationE</span><span class="p">()</span>
		<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">converged</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">csv_read</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># formation_energyでアップデートする</span></div>

<div class="viewcode-block" id="ClusterExpansionExcutor.calculate"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.calculate">[docs]</a>	<span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">constraint_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># return energyをやめた(のでCalculatorもreturn消している) ## 関数説明しろ　dictは{&quot;constraint&quot;:[],&quot;filter&quot;:{&quot;function&quot;:function,&quot;args&quot;:[引数たち]}}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span> <span class="o">=</span> <span class="n">Calculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;single_point&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">single_point</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;optimization&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">optimization</span><span class="p">,</span><span class="n">constraint_dict</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculation type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculation_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not impremented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterExpansionExcutor.ECI_evaruate"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.ECI_evaruate">[docs]</a>	<span class="k">def</span> <span class="nf">ECI_evaruate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ECI_file_name</span><span class="o">=</span><span class="s2">&quot;ECI.json&quot;</span><span class="p">,</span><span class="n">CV_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="c1">## polynomial以外はここでエラーが出るはず。reconstructionでは治らなかった</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluate</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">scoring_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scoring_scheme</span><span class="p">,</span><span class="n">nsplits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nsplits</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="o">==</span><span class="s2">&quot;linear&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">set_fitting_scheme</span><span class="p">(</span><span class="n">fitting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">CV_filename</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
			<span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">plot_CV</span><span class="p">(</span><span class="n">alpha_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">set_fitting_scheme</span><span class="p">(</span><span class="n">fitting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">plot_CV</span><span class="p">(</span><span class="n">alpha_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">savefig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="n">CV_filename</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">set_fitting_scheme</span><span class="p">(</span><span class="n">fitting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitting_scheme</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">save_eci</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="o">+</span><span class="n">ECI_file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterExpansionExcutor.get_basis_function"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.get_basis_function">[docs]</a>	<span class="k">def</span> <span class="nf">get_basis_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unique_element</span><span class="p">):</span>
		<span class="c1"># a basis built for a type of substitution (same element variety)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;polynomial&quot;</span><span class="p">:</span>
			<span class="n">basis_funcion</span> <span class="o">=</span> <span class="n">Polynomial</span><span class="p">(</span><span class="n">unique_element</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;trigonometric&quot;</span><span class="p">:</span>
			<span class="n">basis_funcion</span> <span class="o">=</span> <span class="n">Trigonometric</span><span class="p">(</span><span class="n">unique_element</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_function</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;binary_linear&quot;</span><span class="p">:</span>
			<span class="n">basis_function</span> <span class="o">=</span> <span class="n">BinaryLinear</span><span class="p">(</span><span class="n">unique_element</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;basis function type </span><span class="si">{</span><span class="n">bf_type</span><span class="si">}</span><span class="s2"> is not supported.&quot;</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">basis_funcion</span></div>

<div class="viewcode-block" id="ClusterExpansionExcutor.make_qubit"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.make_qubit">[docs]</a>	<span class="k">def</span> <span class="nf">make_qubit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
		<span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">supercell_multiple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell_multiple</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">!=</span> <span class="s2">&quot;bulk&quot;</span><span class="p">:</span>
				<span class="n">supercell_multiple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">prim_cell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			
			<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">supercell_multiple</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input model does not have specific tag corresponding to symmetrical equivalent sites.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouped_basis</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]:</span>
			<span class="n">grouped_tag</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">prim_cell</span><span class="p">]))]</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1">## まだ直していない</span>
			<span class="n">grouped_basis</span> <span class="o">=</span> <span class="n">CE</span><span class="o">.</span><span class="n">grouped_basis</span> <span class="c1">## CE.grouped_basisがそもそもtagになっていないが、広げた後に対応させるためにtagに対応させる必要がある。</span>
		<span class="n">basis_dict</span> <span class="o">=</span><span class="p">{}</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;ここをtagで管理する&quot;&quot;&quot;</span> <span class="c1">## 実際にはCE.basis_elementsは&quot;all&quot;以外でtagに対応してないので外部で処理の必要</span>
		<span class="k">for</span> <span class="n">elements</span><span class="p">,</span><span class="n">tags</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_elements</span><span class="p">,</span><span class="n">grouped_tag</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
				<span class="n">basis_dict</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">elements</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
		<span class="n">qubit_dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">qubit_index</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">qubits</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
				<span class="n">qubits</span> <span class="o">=</span> <span class="p">[</span><span class="n">qubit_index</span><span class="p">]</span>
				<span class="n">qubit_index</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The tag &#39;</span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39; is not corresponding to any basis.&quot;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">qubits</span> <span class="o">=</span> <span class="p">[</span><span class="n">qubit_index</span><span class="o">+</span><span class="n">addition</span> <span class="k">for</span> <span class="n">addition</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">]))]</span>
				<span class="n">qubit_index</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">])</span>
			<span class="n">qubit_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;variable_num&quot;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">]),</span><span class="s2">&quot;basis&quot;</span><span class="p">:</span><span class="n">basis_dict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">],</span><span class="s2">&quot;tag&quot;</span><span class="p">:</span><span class="n">atom</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span><span class="s2">&quot;qubits&quot;</span><span class="p">:</span><span class="n">qubits</span><span class="p">}</span>
		<span class="k">return</span> <span class="n">qubit_dict</span></div>
		<span class="c1">## bulkはindexをtagに反映していないかも知れないので、広げた後の対称性を明らかにするために,tagを設定するコードを作る。金属間化合物で検証</span>
		<span class="c1">## -&gt; self.tag2grouped_basisがそもそもない slabはbulk2slabでtagつけているし</span>

<div class="viewcode-block" id="ClusterExpansionExcutor.make_QUBO"><a class="viewcode-back" href="../APIreference/allfunc.html#allfunc.ClusterExpansionExcutor.make_QUBO">[docs]</a>	<span class="k">def</span> <span class="nf">make_QUBO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">qubit_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">#Cythonizeをする必要がある</span>
		<span class="c1">## 3次以上で減らせそうなら変数を減らす</span>
		<span class="k">if</span> <span class="n">qubit_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">qubit_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_qubit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
		<span class="n">dimension</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cluster_size</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
		<span class="k">if</span> <span class="n">dimension</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">NotImprementedError</span><span class="p">(</span><span class="s2">&quot;This version of SurfQit does not support HUBO for 5 or higher atoms cluster.&quot;</span><span class="p">)</span>
		<span class="n">basis_set</span>         <span class="o">=</span> <span class="p">{}</span> <span class="c1">## tag毎に構築する</span>
		<span class="k">for</span> <span class="n">qubit_info</span> <span class="ow">in</span> <span class="n">qubit_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basis_set</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="n">basis</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_basis_function</span><span class="p">(</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">])</span>
				<span class="n">basis_set_origin</span>  <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">get_basis_functions</span><span class="p">()</span>
				<span class="n">basis_array</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">phi_i_j</span> <span class="k">for</span> <span class="n">phi_i_j</span> <span class="ow">in</span> <span class="n">phi_i</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span> <span class="k">for</span> <span class="n">phi_i</span> <span class="ow">in</span> <span class="n">basis_set_origin</span><span class="p">])</span>
				<span class="n">basis_set</span><span class="p">[</span><span class="n">qubit_info</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">basis_array</span>
		<span class="c1">## ECIとCFの場所</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annealing_machine</span> <span class="o">==</span> <span class="s2">&quot;FA&quot;</span><span class="p">:</span> 
			<span class="n">max_qubit_index</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">qubit_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
				<span class="n">max_qubit_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_qubit_index</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;qubits&quot;</span><span class="p">]))</span>
			<span class="n">QUBO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">max_qubit_index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dimension</span><span class="p">))</span> <span class="c1">## ここからcythonize可能</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, H.S. &amp; K.S..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>